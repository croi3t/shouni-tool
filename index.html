<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å…ç”¨é‡ç›£æŸ»ãƒ„ãƒ¼ãƒ« V30</title>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #c0392b; --warning: #f39c12; --bg: #f4f7f6; --text: #333; --inj-color: #8e44ad; }
        body { font-family: "Meiryo", "Hiragino Kaku Gothic ProN", sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); line-height: 1.6; }
        header { background: var(--primary); color: #fff; padding: 15px 0; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.4rem; }
        
        /* ã‚¿ãƒ– (å›ºå®šè¡¨ç¤º) */
        .tab-nav { 
            display: flex; justify-content: center; background: #34495e; padding: 0; list-style: none; margin: 0; flex-wrap: wrap;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .tab-nav li { cursor: pointer; padding: 12px 15px; color: #bdc3c7; transition: 0.3s; border-bottom: 4px solid transparent; font-weight: bold; font-size: 0.9rem; }
        .tab-nav li:hover { color: #fff; background: #3e5871; }
        .tab-nav li.active { color: #fff; border-bottom-color: var(--accent); background: #2c3e50; }
        .tab-nav li[data-tab="tab-inj"].active { border-bottom-color: var(--inj-color); }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; }
        
        .tab-content { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ãƒ‘ãƒãƒ«ãƒ»å…¥åŠ› */
        .panel { background: #eef2f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dce4ec; }
        .inj-mode .panel { background: #f3e5f5; border-color: #e1bee7; }
        
        .row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: flex-start; }
        .col { flex: 1; min-width: 150px; }
        
        label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--primary); font-size: 0.95rem; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; transition: all 0.3s; }
        input:disabled { background: #e9ecef; }
        
        /* å¹´é½¢å…¥åŠ›è£œåŠ©ãƒœã‚¿ãƒ³ */
        .age-helper-btn { background: #607d8b; color: white; border: none; padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer; margin-top: 5px; display: block; width: 100%; }
        .age-helper-popup { display: none; background: #fff; border: 1px solid #ccc; padding: 10px; position: absolute; z-index: 200; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 5px; width: 280px; margin-top: 5px; }
        .age-helper-row { display: flex; gap: 5px; align-items: center; margin-bottom: 8px; }
        .age-helper-row input { width: 60px; padding: 5px; text-align: right; }

        /* æ¤œç´¢ãƒªã‚¹ãƒˆ */
        .search-container { position: relative; }
        .drug-list { list-style: none; padding: 0; margin: 0; position: absolute; width: 100%; max-height: 300px; overflow-y: auto; background: #fff; border: 1px solid #ddd; z-index: 100; display: none; box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        .drug-list li { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 16px; }
        .drug-list li:hover { background: #e6f7ff; color: var(--accent); }

        /* ã‚·ãƒŠãƒªã‚ªé¸æŠãƒœã‚¿ãƒ³ */
        .scenario-selector { margin-bottom: 20px; background: #fff8e1; padding: 15px; border: 1px solid #ffe082; border-radius: 6px; }
        .scenario-title { font-weight: bold; color: #f39c12; margin-bottom: 10px; display: block; }
        .scenario-btn { 
            display: inline-block; margin: 5px 5px 5px 0; padding: 10px 15px; 
            background: #fff; border: 2px solid #f39c12; color: #f39c12; 
            font-weight: bold; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem;
        }
        .scenario-btn:hover { background: #fdf2d0; }
        .scenario-btn.active { background: #f39c12; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* çµæœã‚«ãƒ¼ãƒ‰ */
        .result-card { display: none; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff; margin-top: 20px; }
        .card-header { background: var(--primary); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .inj-mode .card-header { background: var(--inj-color); }
        .card-body { padding: 20px; }

        /* åˆ¤å®šãƒœãƒƒã‚¯ã‚¹ */
        .audit-box { padding: 20px; border-radius: 6px; border-left: 6px solid #ccc; background: #f9f9f9; margin-bottom: 20px; font-size: 1.1rem; }
        .audit-safe { background: #e8f5e9; border-left-color: var(--success); color: #1b5e20; }
        .audit-danger { background: #fbe9e7; border-left-color: var(--danger); color: #b71c1c; }
        .audit-check { background: #fff3e0; border-left-color: var(--warning); color: #e65100; }
        
        /* æ¨å¥¨é‡è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .guideline-area { background: #eef2f5; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #ddd; font-weight:bold; color:#2c3e50; }

        .detail-result { font-size: 0.95rem; margin-top: 5px; padding: 8px; background: #fff; border: 1px solid #eee; border-radius: 4px; display: flex; align-items: center; }
        .badge-mini { display: inline-block; padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; color: white; margin-right: 10px; min-width: 40px; text-align: center; }
        .bg-green { background: var(--success); }
        .bg-red { background: var(--danger); }
        .bg-gray { background: #95a5a6; }

        .original-text { background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; color: #444; line-height: 1.8; font-family: inherit; white-space: pre-wrap; word-wrap: break-word; word-break: break-all; }
        
        /* å¼·èª¿è¡¨ç¤º */
        .unit-emph { font-weight: bold; }
        .unit-dose { color: #d35400; }
        .unit-day { color: #2980b9; }
        input.input-dose { border: 2px solid #e67e22; background: #fdf2e9; }
        input.input-day { border: 2px solid #3498db; background: #ebf5fb; }

        /* ãã®ä»– */
        .liquid-switch { display:none; align-items:center; margin-top:5px; font-size:0.9rem; color:#2c3e50; font-weight:bold; }
        .liquid-switch input { width:auto; margin-right:5px; transform:scale(1.2); }
        .ref-links a { display: inline-block; margin-right: 15px; margin-bottom: 8px; color: var(--accent); text-decoration: none; background: #f0f8ff; padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; }
        .ref-links a:hover { background: var(--accent); color: #fff; }
        .ref-nolink { display: inline-block; margin-right: 15px; margin-bottom: 8px; color: #666; background: #f5f5f5; padding: 6px 12px; border-radius: 20px; border: 1px solid #ddd; font-size: 0.9rem; }
        
        #safetyAlertArea { display: none; margin-bottom: 20px; padding: 15px; border-radius: 6px; border-left: 6px solid; font-weight: bold; line-height: 1.5; }
        .safety-danger { background: #fee; border-color: #c0392b; color: #c0392b; }
        .safety-warning { background: #fff3cd; border-color: #f39c12; color: #856404; }
        .input-alert { animation: alertPulse 1.5s infinite; background-color: #fff5f5; }
        @keyframes alertPulse { 0% { box-shadow: 0 0 0 0 rgba(231,76,60,0.7); border-color: #e74c3c; } 70% { box-shadow: 0 0 0 10px rgba(231,76,60,0); border-color: #e74c3c; } 100% { box-shadow: 0 0 0 0 rgba(231,76,60,0); border-color: #e74c3c; } }
        
        .btn-action { color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-action:hover { opacity: 0.9; }
        .data-status { margin-top: 15px; font-weight: bold; text-align: center; color: var(--primary); }
        #errorBanner { display:none; background:#ffdddd; color:red; padding:15px; border:1px solid red; margin:10px; font-weight:bold; }

        /* è³‡æ–™ã‚¿ãƒ– */
        h2 { border-left: 5px solid var(--accent); padding-left: 10px; color: var(--primary); margin-top: 30px; font-size: 1.3rem; }
        .chart-container { width: 100%; height: 400px; position: relative; margin-bottom: 20px; border: 1px solid #eee; background: #fff; }
        .formula-box { background: #fdfdfd; border: 1px solid #eee; padding: 15px; border-radius: 5px; margin-bottom: 15px; height: 100%; }
        .formula-title { font-weight: bold; color: var(--accent); margin-bottom: 5px; }
        .formula-math { font-family: "Times New Roman", serif; font-size: 1.2rem; background: #eee; padding: 10px; text-align: center; border-radius: 4px; margin: 10px 0; }
        .calc-area { background:#f0f0f0; padding:10px; border-radius:4px; margin-top:10px; }
        .source-note { font-size: 0.8rem; color: #666; text-align: right; margin-top: 5px; }
        
        table.common-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; margin-top: 10px; }
        table.common-table th, table.common-table td { border: 1px solid #ddd; padding: 8px 5px; text-align: center; }
        table.common-table th { background: #f2f2f2; color: var(--primary); font-weight: bold; }
        table.common-table tr:nth-child(even) td { background: #fafafa; }
        
        #growthTableContainer { overflow-x: auto; margin-bottom: 10px; }
        #growthTableContainer table { min-width: 600px; }
        #growthTableContainer th:first-child, #growthTableContainer td:first-child { background: #eef2f5; font-weight: bold; width: 80px; position: sticky; left: 0; z-index: 10; border-right: 2px solid #ddd; }
        
        .harnack-table th { text-align: left; padding-left: 15px; width: 40%; }
        .harnack-table td { text-align: left; padding-left: 15px; }
    </style>
    
    <script>
        function switchTab(id) {
            try {
                document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.tab-nav li').forEach(e => e.classList.remove('active'));
                const target = document.getElementById(id); if(target) target.classList.add('active');
                const idx = {'tab-oral':0, 'tab-inj':1, 'tab-knowledge':2, 'tab-settings':3}[id];
                const navItems = document.querySelectorAll('.tab-nav li'); if(navItems[idx]) navItems[idx].classList.add('active');
            } catch(e) { console.error("Tab Error:", e); }
        }
        window.onerror = function(msg, url, line) {
            const banner = document.getElementById('errorBanner');
            if(banner) { banner.style.display = 'block'; banner.innerHTML = `âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${msg} (Line: ${line})`; }
        };
    </script>
</head>
<body>

<header>
    <h1>ğŸ’Š å°å…ç”¨é‡ç›£æŸ»ãƒ„ãƒ¼ãƒ« V30</h1>
</header>

<div id="errorBanner"></div>

<ul class="tab-nav">
    <li class="active" onclick="switchTab('tab-oral')" data-tab="tab-oral">ğŸ’Š å†…æœãƒ»å¤–ç”¨</li>
    <li onclick="switchTab('tab-inj')" data-tab="tab-inj">ğŸ’‰ æ³¨å°„è–¬</li>
    <li onclick="switchTab('tab-knowledge')" data-tab="tab-knowledge">ğŸ“Š è³‡æ–™ãƒ»çŸ¥è­˜</li>
    <li onclick="switchTab('tab-settings')" data-tab="tab-settings">ğŸ› ï¸ ãƒ‡ãƒ¼ã‚¿æ›´æ–°</li>
</ul>

<div class="container">
    <div id="tab-oral" class="tab-content active">
        <div id="loadingStatusOral" style="text-align:center; padding:10px; color:#666; font-size:0.9rem;">â³ æº–å‚™ä¸­...</div>
        <div id="safetyAlertAreaOral"></div>

        <div class="panel">
            <div class="row">
                <div class="col search-container" style="flex: 2;">
                    <label>å†…æœè–¬æ¤œç´¢</label>
                    <input type="text" id="searchBoxOral" placeholder="ä¾‹ï¼šã‚«ãƒ­ãƒŠãƒ¼ãƒ«ã€ã‚¿ãƒŸãƒ•ãƒ«..." autocomplete="off">
                    <ul id="drugListOral" class="drug-list"></ul>
                </div>
            </div>
            <div class="row">
                <div class="col"><label>ä½“é‡ (kg)</label><input type="number" id="weightOral" step="0.1" placeholder="15.5" oninput="runAudit('Oral')"></div>
                <div class="col" style="position:relative;">
                    <label>å¹´é½¢ (æ­³)</label>
                    <input type="number" id="ageOral" step="0.01" placeholder="3" oninput="runAudit('Oral')">
                    <button class="age-helper-btn" onclick="toggleAgeHelper('Oral')">ğŸ‘¶ æœˆé½¢/æ—¥é½¢å…¥åŠ›</button>
                    <div id="ageHelperOral" class="age-helper-popup">
                        <div class="age-helper-row">
                            <label style="width:50px;">æœˆé½¢:</label> <input type="number" id="helperMonthOral" placeholder="0"> ãƒ¶æœˆ
                        </div>
                        <div class="age-helper-row">
                            <label style="width:50px;">æ—¥é½¢:</label> <input type="number" id="helperDayOral" placeholder="0"> æ—¥
                        </div>
                        <div style="text-align:right;">
                            <button class="btn-action" style="font-size:0.8rem; padding:5px; background:#3498db; width:auto;" onclick="applyAgeHelper('Oral')">åæ˜ </button>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <label id="doseLabelOral">å‡¦æ–¹é‡</label>
                    <input type="number" id="doseInputOral" placeholder="å…¥åŠ›" oninput="runAudit('Oral')" disabled>
                    <label class="liquid-switch" id="liquidSwitchOral"><input type="checkbox" id="isLiquidInputOral" onchange="runAudit('Oral')"> mLå…¥åŠ›</label>
                </div>
            </div>
        </div>
        
        <div id="scenarioAreaOral" class="scenario-selector" style="display:none;">
            <span id="scenarioTitleOral" class="scenario-title">ğŸ“Œ é©å¿œãƒ»å¹´é½¢åŒºåˆ†:</span><div id="scenarioOptionsOral"></div>
        </div>

        <div id="resultCardOral" class="result-card">
            <div class="card-header">
                <div><span id="resNameOral" style="font-weight:bold; font-size:1.2rem;"></span><span id="resGenericOral" style="font-size:0.9rem; margin-left:10px; opacity:0.9;"></span></div>
                <span id="auditTypeBadgeOral" class="dose-label"></span>
            </div>
            <div class="card-body">
                <div id="guidelineAreaOral" class="guideline-area" style="display:none;"></div>
                <div id="auditResultOral"></div>
                
                <div style="margin-top:20px; margin-bottom:8px; font-weight:bold; color:var(--primary);">åŸæ–‡:</div>
                <div id="resPedsTextOral" class="original-text"></div>
                <div id="refAreaOral" style="margin-top:20px; display:none;"><div id="refLinksContainerOral" class="ref-links"></div></div>
            </div>
        </div>
    </div>

    <div id="tab-inj" class="tab-content inj-mode">
        <div id="safetyAlertAreaInj"></div>

        <div class="panel">
            <div class="row">
                <div class="col search-container" style="flex: 2;">
                    <label style="color:#8e44ad;">ğŸ’‰ æ³¨å°„è–¬æ¤œç´¢</label>
                    <input type="text" id="searchBoxInj" placeholder="ä¾‹ï¼šã‚¢ãƒŸã‚«ã‚·ãƒ³ã€ãƒ¢ãƒ€ã‚·ãƒ³..." autocomplete="off">
                    <ul id="drugListInj" class="drug-list"></ul>
                </div>
            </div>
            <div class="row">
                <div class="col"><label>ä½“é‡ (kg)</label><input type="number" id="weightInj" step="0.1" placeholder="15.5" oninput="runAudit('Inj')"></div>
                <div class="col" style="position:relative;">
                    <label>å¹´é½¢ (æ­³)</label>
                    <input type="number" id="ageInj" step="0.01" placeholder="3" oninput="runAudit('Inj')">
                    <button class="age-helper-btn" style="background:#9b59b6;" onclick="toggleAgeHelper('Inj')">ğŸ‘¶ æœˆé½¢/æ—¥é½¢å…¥åŠ›</button>
                    <div id="ageHelperInj" class="age-helper-popup">
                        <div class="age-helper-row">
                            <label style="width:50px;">æœˆé½¢:</label> <input type="number" id="helperMonthInj" placeholder="0"> ãƒ¶æœˆ
                        </div>
                        <div class="age-helper-row">
                            <label style="width:50px;">æ—¥é½¢:</label> <input type="number" id="helperDayInj" placeholder="0"> æ—¥
                        </div>
                        <div style="text-align:right;">
                            <button class="btn-action" style="font-size:0.8rem; padding:5px; background:#8e44ad; width:auto;" onclick="applyAgeHelper('Inj')">åæ˜ </button>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <label id="doseLabelInj">å‡¦æ–¹é‡</label>
                    <input type="number" id="doseInputInj" placeholder="å…¥åŠ›" oninput="runAudit('Inj')" disabled>
                    <label class="liquid-switch" id="liquidSwitchInj"><input type="checkbox" id="isLiquidInputInj" onchange="runAudit('Inj')"> mLå…¥åŠ›</label>
                </div>
            </div>
        </div>
        
        <div id="scenarioAreaInj" class="scenario-selector" style="display:none;">
            <span id="scenarioTitleInj" class="scenario-title">ğŸ“Œ åŒºåˆ†ã‚’é¸æŠ:</span><div id="scenarioOptionsInj"></div>
        </div>

        <div id="resultCardInj" class="result-card">
            <div class="card-header">
                <div><span id="resNameInj" style="font-weight:bold; font-size:1.2rem;"></span><span id="resGenericInj" style="font-size:0.9rem; margin-left:10px; opacity:0.9;"></span></div>
                <span id="auditTypeBadgeInj" class="dose-label"></span>
            </div>
            <div class="card-body">
                <div id="guidelineAreaInj" class="guideline-area" style="display:none;"></div>
                <div id="auditResultInj"></div>
                
                <div style="margin-top:20px; margin-bottom:8px; font-weight:bold; color:#8e44ad;">åŸæ–‡:</div>
                <div id="resPedsTextInj" class="original-text"></div>
                <div id="refAreaInj" style="margin-top:20px; display:none;"><div id="refLinksContainerInj" class="ref-links"></div></div>
            </div>
        </div>
    </div>

    <div id="tab-knowledge" class="tab-content">
        <h2>ğŸ“Š èº«ä½“ç™ºè‚²æ›²ç·š (0-12æ­³)</h2>
        <div class="row">
            <div class="col"><h3 style="text-align:center; color:#e74c3c; margin:0 0 10px 0;">å¥³å­ (Girls)</h3><div id="chartGirl" class="chart-container"></div></div>
            <div class="col"><h3 style="text-align:center; color:#3498db; margin:0 0 10px 0;">ç”·å­ (Boys)</h3><div id="chartBoy" class="chart-container"></div></div>
        </div>
        
        <h3>ğŸ“ˆ æ—¥æœ¬äººå°å…ã®å¹³å‡ä½“é‡ä¸€è¦§è¡¨ (kg)</h3>
        <div id="growthTableContainer"></div>
        <div class="source-note">å‡ºå…¸ï¼šåšç”ŸåŠ´åƒçœ ä¹³å¹¼å…èº«ä½“ç™ºè‚²èª¿æŸ»ï¼ˆå¹³æˆ22å¹´ï¼‰ã€å­¦æ ¡ä¿å¥çµ±è¨ˆèª¿æŸ»ï¼ˆå¹³æˆ30å¹´ï¼‰ç­‰ã«åŸºã¥ãæ¦‚ç®—å€¤</div>
        
        <h2>ğŸ§® è¨ˆç®—å¼</h2>
        <div class="row">
            <div class="col">
                <div class="formula-box">
                    <div class="formula-title">Augsbergerå¼ II</div>
                    <div class="formula-math">å°å…é‡ = æˆäººé‡ Ã— ( ä½“é‡ Ã— 4 + 20 ) / 100</div>
                    <div class="calc-area">
                        æˆäºº: <input type="number" id="augAdult" style="width:100px;">mg Ã— ä½“é‡: <input type="number" id="augWeight" style="width:100px;">kg 
                        <button onclick="calcAugsberger()">è¨ˆç®—</button> = <span id="augResult" style="font-weight:bold;">---</span> mg
                    </div>
                    <div class="source-note">å‡ºå…¸ï¼šAugsberger A: Klin. Wochenschr., 32: 945, 1954</div>
                </div>
            </div>
            <div class="col">
                <div class="formula-box">
                    <div class="formula-title">Schwartzã®å¼ (eGFRæ¨ç®—)</div>
                    <div style="font-size:0.85rem; color:#666;">2æ­³ä»¥ä¸Š11æ­³ä»¥ä¸‹ã®æ—¥æœ¬äººå°å…ç”¨ç°¡æ˜“å¼</div>
                    <div class="formula-math">eGFR = 0.35 Ã— èº«é•·(cm) / è¡€æ¸…Cr</div>
                    <div class="calc-area">
                        èº«é•·: <input type="number" id="schHeight" style="width:100px;">cm / Cr: <input type="number" id="schCr" style="width:100px;">
                        <button onclick="calcSchwartz()">è¨ˆç®—</button> = <span id="schResult" style="font-weight:bold;">---</span>
                    </div>
                    <div class="source-note">å‡ºå…¸ï¼šæ—¥æœ¬å°å…è…è‡“ç—…å­¦ä¼š æ—¥æœ¬äººå°å…ã®æ¨ç®—ç³¸çƒä½“æ¿¾éé‡(eGFR)</div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="formula-box">
                    <div class="formula-title">Von Harnackè¡¨ (ç°¡æ˜“è¨ˆç®—)</div>
                    <div class="calc-area">
                        æˆäºº: <input type="number" id="harAdult" style="width:100px;">mg Ã— å¹´é½¢: <input type="number" id="harAge" style="width:100px;">æ­³
                        <button onclick="calcHarnack()">è¨ˆç®—</button> = <span id="harResult" style="font-weight:bold;">---</span> mg
                    </div>
                    <table class="common-table harnack-table"><tr><th>æœªç†Ÿå…</th><td>1/20 ï½ 1/10</td></tr><tr><th>æ–°ç”Ÿå…</th><td>1/10 ï½ 1/8</td></tr><tr><th>ä¹³å…(~6ãƒ¶æœˆ)</th><td>1/8 ï½ 1/6</td></tr><tr><th>ä¹³å…(6ãƒ¶æœˆ~)</th><td>1/6 ï½ 1/5</td></tr><tr><th>å¹¼å…(1-3)</th><td>1/5 ï½ 1/4</td></tr><tr><th>å¹¼å…(3-7.5)</th><td>1/4 ï½ 1/3</td></tr><tr><th>å­¦ç«¥(7.5-12)</th><td>1/3 ï½ 1/2</td></tr><tr><th>å­¦ç«¥(12~)</th><td>1/2 ï½ 3/4</td></tr></table>
                    <div class="source-note">å‡ºå…¸ï¼švon Harnack GA: Arzneimitteldosierung im Kindesalter, 1965</div>
                </div>
            </div>
            <div class="col">
                <div class="formula-box">
                    <div class="formula-title">Youngå¼</div>
                    <div class="formula-math">å°å…é‡ = æˆäººé‡ Ã— å¹´é½¢ / ( å¹´é½¢ + 12 )</div>
                    <div class="calc-area">
                        æˆäºº: <input type="number" id="yngAdult" style="width:100px;">mg Ã— å¹´é½¢: <input type="number" id="yngAge" style="width:100px;">æ­³
                        <button onclick="calcYoung()">è¨ˆç®—</button> = <span id="yngResult" style="font-weight:bold;">---</span> mg
                    </div>
                    <div class="source-note">å‡ºå…¸ï¼šYoung T: An Introduction to Medical Literature, London, 1813</div>
                    
                    <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">
                    
                    <div class="formula-title">Crawfordå¼</div>
                    <div class="formula-math">å°å…é‡ = æˆäººé‡ Ã— ä½“è¡¨é¢ç©(mÂ²) / 1.73</div>
                    <div class="calc-area">
                        æˆäºº: <input type="number" id="crawAdult" style="width:100px;">mg <br>
                        èº«é•·: <input type="number" id="crawHt" style="width:100px;">cm / ä½“é‡: <input type="number" id="crawWt" style="width:100px;">kg
                        <button onclick="calcCrawford()">è¨ˆç®—</button><br>
                        BSA: <span id="crawBSA">---</span> mÂ² â†’ <span id="crawResult" style="font-weight:bold;">---</span> mg
                    </div>
                    <div class="source-note">å‡ºå…¸ï¼šCrawford JD: Pediatrics, 6: 78, 1950<br>BSAè¨ˆç®—: DuBoiså¼ã‚’ä½¿ç”¨</div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content">
        <h2>ğŸ› ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†</h2>
        <p>Excelãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€ãƒ†ã‚¹ãƒˆã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚</p>
        <div style="background:#e3f2fd; padding:15px; border-left:5px solid #2196f3; margin-bottom:15px; font-size:0.9rem;">
            <strong>ğŸ“ Excelè²¼ã‚Šä»˜ã‘åˆ—é † (å…¨13åˆ—):</strong><br>
            [1]å•†å“ [2]ä¸€èˆ¬ [3]ã‚ˆã¿ [4]æ–‡ [5]æœ€å° [6]æœ€å¤§ [7]å˜ä½ [8]ä¸Šé™ [9]å‚ç…§ [10]å¹´é½¢ãƒ«ãƒ¼ãƒ« [11]æ¿ƒåº¦ [12]åŒºåˆ† [13]ã‚°ãƒ«ãƒ¼ãƒ—ID
        </div>
        <textarea id="pasteArea" rows="12" placeholder="ã“ã“ã«Excelã‚’è²¼ã‚Šä»˜ã‘..."></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-action" style="background:#27ae60;" onclick="applyLocalData()">â–¶ï¸ ãƒ†ã‚¹ãƒˆåæ˜ </button>
            <button class="btn-action" style="background:#2980b9;" onclick="downloadJsonFile()">â¬‡ï¸ JSONä½œæˆ (GitHubç”¨)</button>
        </div>
        <div id="saveStatus" class="data-status"></div>
    </div>
</div>

<script>
    let dbDrugs = [];
    let currentOralDrug = null, currentInjDrug = null;
    let currentOralRule = null, currentInjRule = null;
    let currentOralWarning = null, currentInjWarning = null;

    // ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«
    const specialDrugRules = {
        "ã‚¿ãƒŸãƒ•ãƒ«": [
            { label: "æ²»ç™‚ (<1æ­³): 6mg/kg", rule: { min:6, max:6, unit:0 } },
            { label: "æ²»ç™‚ (1æ­³~): 4mg/kg (Max150)", rule: { min:4, max:4, unit:0, limitDay:150 } },
            { label: "äºˆé˜²: 2mg/kg (Max75)", rule: { min:2, max:2, unit:0, limitDay:75 } }
        ],
        "ã‚ªã‚»ãƒ«ã‚¿ãƒŸãƒ“ãƒ«": [
            { label: "æ²»ç™‚ (<1æ­³): 6mg/kg", rule: { min:6, max:6, unit:0 } },
            { label: "æ²»ç™‚ (1æ­³~): 4mg/kg (Max150)", rule: { min:4, max:4, unit:0, limitDay:150 } },
            { label: "äºˆé˜²: 2mg/kg (Max75)", rule: { min:2, max:2, unit:0, limitDay:75 } }
        ],
        "ãƒ‡ã‚«ãƒ‰ãƒ­ãƒ³": [
            { label: "å–˜æ¯", rule: { min:0.2, max:0.3, unit:1 } },
            { label: "ã‚¯ãƒ«ãƒ¼ãƒ—", rule: { min:0.15, max:0.6, unit:1 } },
            { label: "å…ˆå¤©æ€§å‰¯è…éå½¢æˆ", ageRule: { list:[{start:0, end:100, dose:0.5}], unit:0 } }
        ],
        "ãƒ‡ã‚­ã‚µãƒ¡ã‚¿ã‚¾ãƒ³": [
            { label: "å–˜æ¯", rule: { min:0.2, max:0.3, unit:1 } },
            { label: "ã‚¯ãƒ«ãƒ¼ãƒ—", rule: { min:0.15, max:0.6, unit:1 } },
            { label: "å…ˆå¤©æ€§å‰¯è…éå½¢æˆ", ageRule: { list:[{start:0, end:100, dose:0.5}], unit:0 } }
        ]
    };

    const drugWarnings = [
        { key: "ãƒŸãƒã‚µã‚¤ã‚¯ãƒªãƒ³", limitAge: 8, msg: "âš ï¸ã€8æ­³æœªæº€ åŸå‰‡ç¦å¿Œã€‘æ­¯ç‰™é»„æŸ“ãƒ»éª¨ç™ºè‚²ä¸å…¨ãƒªã‚¹ã‚¯" },
        { key: "ã‚¢ã‚¹ãƒ”ãƒªãƒ³", limitAge: 15, msg: "âš ï¸ã€15æ­³æœªæº€ã€‘ãƒ©ã‚¤ç—‡å€™ç¾¤ãƒªã‚¹ã‚¯(å·å´ç—…é™¤ã)" },
        { key: "ãƒ”ãƒ¬ãƒã‚¢", limitAge: 2, msg: "âš ï¸ã€2æ­³æœªæº€ ç¦å¿Œã€‘å‘¼å¸æŠ‘åˆ¶" },
        { key: "ãƒ—ãƒ­ãƒ¡ã‚¿ã‚¸ãƒ³", limitAge: 2, msg: "âš ï¸ã€2æ­³æœªæº€ ç¦å¿Œã€‘å‘¼å¸æŠ‘åˆ¶" },
        { key: "ãƒ¬ãƒœãƒ•ãƒ­ã‚­ã‚µã‚·ãƒ³", limitAge: 18, msg: "âš ï¸ã€å°å…ã€‘é–¢ç¯€éšœå®³ãƒªã‚¹ã‚¯" },
        { key: "ãƒˆã‚¹ãƒ•ãƒ­ã‚­ã‚µã‚·ãƒ³", limitAge: 18, msg: "âš ï¸ã€å°å…ã€‘é–¢ç¯€éšœå®³ãƒªã‚¹ã‚¯" },
        { key: "ã‚·ãƒ—ãƒ­ãƒ•ãƒ­ã‚­ã‚µã‚·ãƒ³", limitAge: 18, msg: "âš ï¸ã€å°å…ã€‘é–¢ç¯€éšœå®³ãƒªã‚¹ã‚¯" },
        { key: "ãƒãƒ«ãƒ•ãƒ­ã‚­ã‚µã‚·ãƒ³", limitAge: 18, msg: "âš ï¸ã€å°å…ã€‘é–¢ç¯€éšœå®³ãƒªã‚¹ã‚¯" },
        { key: "ãƒ—ãƒ­ãƒãƒ•ã‚©ãƒ¼ãƒ«", limitAge: 100, msg: "âš ï¸ã€å°å…ã€‘é›†ä¸­æ²»ç™‚ã«ãŠã‘ã‚‹é®é™ã¯ç¦å¿Œ(ãƒ—ãƒ­ãƒãƒ•ã‚©ãƒ¼ãƒ«æ³¨å…¥ç—‡å€™ç¾¤)" }
    ];

    const dbRefs = { 1:{title:"æ·»ä»˜æ–‡æ›¸",url:""}, 2:{title:"æ–°å°å…è–¬é‡é‡",url:""}, 3:{title:"å…ˆå¤©æ€§å¿ƒç–¾æ‚£GL",url:"https://www.j-circ.or.jp/cms/wp-content/uploads/2020/02/JCS2018_Yasukochi.pdf"}, 4:{title:"å°å…çµæ ¸è¨ºç™‚ã¦ã³ã",url:"https://jata.or.jp/wp-content/uploads/2025/04/shouni_tebiki_202504.pdf"}, 5:{title:"Official ATS/CDC Guidelines",url:"https://academic.oup.com/cid/article/63/7/e147/2196792"}, 6:{title:"æ–°ç”Ÿå…ãƒã‚¹ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°GL",url:"https://jsimd.net/pdf/newborn-mass-screening-disease-practice-guideline2019_v2.pdf"}, 7:{title:"ãƒã‚¯ãƒ­ãƒ©ã‚¤ãƒ‰ç³»æŠ—ç”Ÿç‰©è³ªã®æ–°ã—ã„å±•é–‹",url:"https://search.jamas.or.jp/default/link?pub_year=2000&ichushi_jid=J01816&link_issn=&doc_id=20001128020009&doc_link_id=%2Fac3rbbtb%2F2000%2F002706%2F009%2F0839-0842%26dl%3D0&url=https%3A%2F%2Fwww.medicalonline.jp%2Fjamas.php%3FGoodsID%3D%2Fac3rbbtb%2F2000%2F002706%2F009%2F0839-0842%26dl%3D0&type=MedicalOnline&icon=https%3A%2F%2Fjk04.jamas.or.jp%2Ficon%2F00004_2.gif"}, 8:{title:"ä»Šæ—¥ã®æ²»ç™‚æŒ‡é‡2025ï¼è†€èƒ±å°¿ç®¡é€†æµ",url:""}, 9:{title:"Medspace",url:"https://reference.medscape.com/drug/valium-valtoco-diazepam-342902"}, 10:{title:"æœªæ‰¿èªè–¬ãƒ»é©å¿œå¤–è–¬ã®è¦æœ›",url:"https://www.mhlw.go.jp/topics/2012/03/dl/kigyoukenkai-160.pdf"}, 11:{title:"JAID/JSC æ„ŸæŸ“ç—‡æ²»ç™‚ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³",url:"https://www.chemotherapy.or.jp/uploads/files/guideline/jaidjsc-kansenshochiryo_nyouro.pdf"}, 12:{title:"å°å…æ°—ç®¡æ”¯å–˜æ¯æ²»ç™‚ãƒ»ç®¡ç†ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³",url:""}, 13:{title:"UpToDate æ€¥æ€§å–˜æ¯å¢—æ‚ª",url:"https://www.uptodate.com/contents/acute-asthma-exacerbations-in-children-younger-than-12-years-emergency-department-management"}, 14:{title:"UpToDate å…ˆå¤©æ€§å‰¯è…éå½¢æˆ",url:"https://www.uptodate.com/contents/classic-congenital-adrenal-hyperplasia-due-to-21-hydroxylase-deficiency-in-infants-and-children-treatment"}, 15:{title:"è»½ç—‡èƒƒè…¸ç‚é–¢é€£ã‘ã„ã‚Œã‚“ã«å¯¾ã™ã‚‹carbamazepine",url:"https://www.jstage.jst.go.jp/article/ojjscn1969/37/6/37_6_493/_pdf/-char/ja"}, 16:{title:"ä»Šæ—¥ã®å°å…æ²»ç™‚æŒ‡é‡17ç‰ˆ>VitDæ¬ ä¹",url:""}, 17:{title:"ä»Šæ—¥ã®å°å…æ²»ç™‚æŒ‡é‡17ç‰ˆ>æ–°ç”Ÿå…ä½Ca",url:""}, 18:{title:"ä»Šæ—¥ã®å°å…æ²»ç™‚æŒ‡é‡17ç‰ˆ>æ€¥æ€§ä¸‹ç—¢",url:""}, 19:{title:"æ–°ç”Ÿå…è¨ºç™‚ãƒãƒ‹ãƒ¥ã‚¢ãƒ«",url:""}, 20:{title:"å‘¨ç”£æœŸåŒ»å­¦ 50 (å¢—åˆŠ) 2020",url:"https://mol.medicalonline.jp/library/journal/download?GoodsID=aq9syuse/2020/0050s1/138&name=0588-0591j"}, 21:{title:"åŒ»å¸«ã®ã¿é–²è¦§å¯èƒ½ãƒãƒ‹ãƒ¥ã‚¢ãƒ«",url:""}, 22:{title:"å°å…å¿ƒä¸å…¨è–¬ç‰©æ²»ç™‚ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³",url:"https://jpccs.jp/10.9794/jspccs.31.S2_1/data/index.html"}, 23:{title:"ä»Šæ—¥ã®æ²»ç™‚æŒ‡é‡2024>ä¾¿ç§˜",url:""}, 24:{title:"ä»Šæ—¥ã®å°å…æ²»ç™‚æŒ‡é‡17ç‰ˆ>ã‚¦ã‚¤ãƒ«ã‚¹æ€§èƒƒè…¸ç‚",url:""}, 25:{title:"å°å…ç§‘ã§ã™ãã«æˆ¦ãˆã‚‹ãƒ›ã‚³ã¨ã‚¿ãƒ†",url:""}, 26:{title:"ä¹³å…èƒƒé£Ÿé“é€†æµ å…­å›å­æ¹¯",url:"https://www.jstage.jst.go.jp/article/jjsps/52/2/52_243/_pdf/-char/ja"}, 27:{title:"ä»Šæ—¥ã®å°å…æ²»ç™‚æŒ‡é‡17ç‰ˆ>èƒƒé£Ÿé“é€†æµ",url:""}, 28:{title:"å‘¨ç”£æœŸåŒ»å­¦ 50 (å¢—åˆŠ) 458-462",url:"https://mol.medicalonline.jp/library/journal/download?GoodsID=aq9syuse/2020/0050s1/106&name=0458-0462j"}, 29:{title:"ãƒ„ãƒ ãƒ©MEDICAL SITE",url:"https://medical.tsumura.co.jp/support/knowledge/20221104_2.html"}, 30:{title:"å…¬çŸ¥ç”³è«‹ã¸ã®è©²å½“æ€§ã«ä¿‚ã‚‹å ±å‘Šæ›¸",url:"https://www.mhlw.go.jp/stf/shingi/2r9852000000ti7f-att/2r9852000000tie2.pdf"}, 31:{title:"æ–°ç”Ÿå…é‰„å‰¤æŠ•ä¸ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³",url:"http://jsnhd.or.jp/pdf/31-1-159-185.pdf"}, 32:{title:"IWK Health Neonatal Guidelines",url:"https://www.dir.iwk.nshealth.ca/Home/DDGDetails/46d8310f-1d91-e911-80f2-005056b200d2?PatientPopulation=Neo"} };
    const growthData = { boy: [[0,3.0],[1,9.6],[2,12.5],[3,14.6],[4,16.7],[5,18.9],[6,21.4],[7,24.1],[8,27.2],[9,30.6],[10,34.2],[11,38.2],[12,42.5]], girl: [[0,3.0],[1,8.9],[2,11.8],[3,14.0],[4,16.2],[5,18.5],[6,20.9],[7,23.6],[8,26.5],[9,30.0],[10,33.8],[11,38.0],[12,42.0]] };

    window.onload = function() {
        try {
            drawGrowthChart('chartGirl', 'girl'); drawGrowthChart('chartBoy', 'boy'); drawGrowthTable();
            fetch('./database.json').then(r=>r.json()).then(d=>{ dbDrugs=d; document.getElementById('loadingStatusOral').innerHTML=`âœ… DBæ¥ç¶šå®Œäº† (${d.length}ä»¶)`; })
            .catch(e=>{ const local=localStorage.getItem('pediatric_drug_db'); if(local){ dbDrugs=JSON.parse(local); document.getElementById('loadingStatusOral').innerHTML=`âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ (${dbDrugs.length}ä»¶)`; } else { document.getElementById('loadingStatusOral').innerHTML=`â„¹ï¸ ãƒ‡ãƒ¼ã‚¿æœªç™»éŒ²`; } });
        } catch(e){ console.error("Init:", e); }
    };

    function setupSearch(type) {
        const box = document.getElementById(`searchBox${type}`);
        const list = document.getElementById(`drugList${type}`);
        box.addEventListener('keyup', (e) => {
            const val = e.target.value.toLowerCase().replace(/\s+/g, '');
            if (!val) { list.style.display = 'none'; return; }
            list.innerHTML = '';
            const targetType = (type === 'Inj') ? 1 : 0;
            const groups = new Map(); const singles = [];
            dbDrugs.forEach(d => {
                const dType = (d.type !== undefined) ? d.type : 0;
                if (dType !== targetType) return;
                if (d.name.toLowerCase().includes(val) || d.generic.toLowerCase().includes(val) || d.yomi.replace(/\s+/g, '').includes(val)) {
                    if (d.groupId) { if (!groups.has(d.groupId)) groups.set(d.groupId, d); } else singles.push(d);
                }
            });
            const showItem = (d, isGroup) => {
                const li = document.createElement('li');
                li.textContent = `${d.name} (${d.generic})` + (isGroup ? " [é¸æŠ]" : "");
                li.onclick = () => selectDrug(d, type); list.appendChild(li);
            };
            groups.forEach(d => showItem(d, true));
            singles.forEach(d => showItem(d, false));
            list.style.display = (groups.size + singles.length > 0) ? 'block' : 'none';
        });
    }
    setupSearch('Oral'); setupSearch('Inj');

    function toggleAgeHelper(type) {
        const popup = document.getElementById(`ageHelper${type}`);
        popup.style.display = (popup.style.display === 'block') ? 'none' : 'block';
    }
    
    function applyAgeHelper(type) {
        const m = parseFloat(document.getElementById(`helperMonth${type}`).value) || 0;
        const d = parseFloat(document.getElementById(`helperDay${type}`).value) || 0;
        if(m === 0 && d === 0) return;
        const age = (m / 12) + (d / 365);
        document.getElementById(`age${type}`).value = age.toFixed(3);
        document.getElementById(`ageHelper${type}`).style.display = 'none';
        document.getElementById(`helperMonth${type}`).value = '';
        document.getElementById(`helperDay${type}`).value = '';
        runAudit(type);
    }

    function selectDrug(drug, type) {
        if (type === 'Oral') { currentOralDrug = drug; currentOralRule = drug; } 
        else { currentInjDrug = drug; currentInjRule = drug; }
        
        document.getElementById(`searchBox${type}`).value = drug.name;
        document.getElementById(`drugList${type}`).style.display = 'none';
        document.getElementById(`doseInput${type}`).disabled = false;
        document.getElementById(`resultCard${type}`).style.display = 'block';
        
        document.getElementById(`resName${type}`).textContent = drug.name;
        document.getElementById(`resGeneric${type}`).textContent = drug.generic;
        document.getElementById(`resPedsText${type}`).textContent = drug.text || "ï¼ˆæ·»ä»˜æ–‡æ›¸ç­‰ã®è¨˜è¼‰ãªã—ï¼‰";
        updateRefs(drug, type);

        const liqSwitch = document.getElementById(`liquidSwitch${type}`);
        document.getElementById(`isLiquidInput${type}`).checked = false;
        if (drug.conc && drug.conc > 0) {
            liqSwitch.style.display = 'inline-flex';
            liqSwitch.innerHTML = `<input type="checkbox" id="isLiquidInput${type}" onchange="runAudit('${type}')"> mLå…¥åŠ› (æ¿ƒåº¦:${drug.conc}mg/mL)`;
        } else { liqSwitch.style.display = 'none'; }

        let warning = null;
        const alertArea = document.getElementById(`safetyAlertArea${type}`);
        alertArea.style.display = "none";
        for (const w of drugWarnings) {
            if (drug.name.includes(w.key) || drug.generic.includes(w.key)) {
                warning = w; alertArea.innerHTML = w.msg; alertArea.className = "safety-warning"; alertArea.style.display = "block";
                document.getElementById(`age${type}`).classList.add('input-alert'); break;
            }
        }
        if (type === 'Oral') currentOralWarning = warning; else currentInjWarning = warning;
        if (!warning) document.getElementById(`age${type}`).classList.remove('input-alert');

        const scenDiv = document.getElementById(`scenarioArea${type}`);
        const optsDiv = document.getElementById(`scenarioOptions${type}`);
        optsDiv.innerHTML = '';
        let scenarios = [];
        
        if (drug.groupId) {
            const targetType = (type === 'Inj') ? 1 : 0;
            const groupMembers = dbDrugs.filter(d => d.groupId === drug.groupId && ((d.type||0) === targetType));
            scenarios = groupMembers.map(d => ({ ...d, label: d.name })); 
        } else {
            for (const [key, list] of Object.entries(specialDrugRules)) {
                if (drug.name.includes(key) || drug.generic.includes(key)) { scenarios = list; break; }
            }
        }

        if (scenarios && scenarios.length > 0) {
            scenDiv.style.display = 'block';
            document.getElementById(`scenarioTitle${type}`).textContent = drug.groupId ? "ğŸ“Œ åŒºåˆ†ã‚’é¸æŠ:" : "ğŸ“Œ é©å¿œãƒ»å¹´é½¢åŒºåˆ†:";
            scenarios.forEach((s, idx) => {
                const btn = document.createElement('button');
                btn.className = "scenario-btn";
                btn.textContent = s.label;
                btn.onclick = () => {
                    Array.from(optsDiv.children).forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const selectedRule = s.rule ? s.rule : s;
                    if(drug.groupId){
                        document.getElementById(`resName${type}`).textContent = s.name;
                        document.getElementById(`resPedsText${type}`).textContent = s.text || "ï¼ˆè¨˜è¼‰ãªã—ï¼‰";
                        updateRefs(s, type);
                    }
                    applyRule(selectedRule, type);
                    runAudit(type); 
                };
                if (idx === 0) btn.click();
                optsDiv.appendChild(btn);
            });
        } else {
            scenDiv.style.display = 'none';
            applyRule(drug, type);
            updateRefs(drug, type);
        }
        runAudit(type);
    }

    function updateRefs(drug, type) {
        const refDiv = document.getElementById(`refLinksContainer${type}`); 
        refDiv.innerHTML = '';
        document.getElementById(`refArea${type}`).style.display = (drug.refs && drug.refs.length > 0) ? 'block' : 'none';
        if(drug.refs && drug.refs.length > 0) {
            drug.refs.forEach(id => {
                const d = dbRefs[id]; 
                const a = document.createElement('a'); 
                a.textContent = `[${id}] ${d ? d.title : 'æ–‡çŒ®'}`;
                if (d && d.url) { a.href = d.url; a.target = "_blank"; } 
                else { a.className = 'ref-nolink'; }
                refDiv.appendChild(a);
            });
        }
    }

    function applyRule(data, type) {
        if (type === 'Oral') currentOralRule = data; else currentInjRule = data;
        const badge = document.getElementById(`auditTypeBadge${type}`);
        const doseLabel = document.getElementById(`doseLabel${type}`);
        const inputField = document.getElementById(`doseInput${type}`);
        let unit = 0;
        if (data.ageRule) unit = data.ageRule.unit; else if (data.rule) unit = data.rule.unit;

        if (data.ageRule || data.rule) {
            if (unit === 1) { 
                doseLabel.innerHTML = 'å‡¦æ–¹é‡ <span class="unit-emph unit-dose">(1å›é‡)</span>';
                badge.textContent = "åŸºæº–: 1å›é‡"; badge.style.background = "#fff3cd"; badge.style.color = "#d35400";
                inputField.className = "input-dose";
            } else { 
                doseLabel.innerHTML = 'å‡¦æ–¹é‡ <span class="unit-emph unit-day">(1æ—¥ç·é‡)</span>';
                badge.textContent = "åŸºæº–: 1æ—¥ç·é‡"; badge.style.background = "#d1ecf1"; badge.style.color = "#2980b9";
                inputField.className = "input-day";
            }
        } else {
            doseLabel.textContent = "å‡¦æ–¹é‡ (åˆ¤å®šä¸å¯)";
            badge.textContent = "ç›®è¦–ã®ã¿"; badge.style.background = "#e2e3e5"; badge.style.color = "#383d41";
            inputField.className = "";
        }
    }

    function runAudit(type) {
        const drug = (type === 'Oral') ? currentOralDrug : currentInjDrug;
        const rule = (type === 'Oral') ? currentOralRule : currentInjRule;
        const warning = (type === 'Oral') ? currentOralWarning : currentInjWarning;
        const resBox = document.getElementById(`auditResult${type}`);
        const guidelineArea = document.getElementById(`guidelineArea${type}`);
        
        if (!drug || !rule) return;

        const weight = parseFloat(document.getElementById(`weight${type}`).value);
        const age = parseFloat(document.getElementById(`age${type}`).value);
        const rawInput = parseFloat(document.getElementById(`doseInput${type}`).value);
        let inputDose = rawInput;
        const isLiquid = document.getElementById(`isLiquidInput${type}`).checked;
        const drugConc = (drug && drug.conc) ? drug.conc : 0;
        if (isLiquid && !isNaN(rawInput) && drugConc > 0) inputDose = rawInput * drugConc;

        const alertArea = document.getElementById(`safetyAlertArea${type}`);
        if (warning) {
            if (!isNaN(age) && age < warning.limitAge) { alertArea.className = "safety-danger"; document.getElementById(`age${type}`).classList.remove('input-alert'); }
            else if (!isNaN(age)) { alertArea.className = "safety-warning"; document.getElementById(`age${type}`).classList.remove('input-alert'); }
            else { document.getElementById(`age${type}`).classList.add('input-alert'); }
        }

        const calcRange = (minMg, maxMg, unitStr) => {
            let suffix = "";
            if (drugConc > 0) { const minML = (minMg / drugConc).toFixed(2); const maxML = (maxMg / drugConc).toFixed(2); suffix = `<br><span style="color:#0d47a1">(${minML} ï½ ${maxML} mL)</span>`; }
            return `<strong>${minMg.toFixed(2)}ï½${maxMg.toFixed(2)} <span class="unit-emph ${unitStr=='å›'?'unit-dose':'unit-day'}">mg/${unitStr}</span></strong>${suffix}`;
        };

        let guideHtml = "";
        let resultHtml = "";
        let isAgeSafe=false, isWeightSafe=false;
        let hasAgeRule=false, hasWeightRule=false;

        // A: Age Rule
        if (rule.ageRule && !isNaN(age)) {
            hasAgeRule = true;
            const ar = rule.ageRule; const unitStr = ar.unit === 1 ? "å›" : "æ—¥";
            const match = ar.list.find(r => age >= r.start && age < r.end);
            if (match) {
                let tMin = match.dose, tMax = match.dose;
                if(match.isKg && weight) { tMin *= weight; tMax *= weight; }
                guideHtml += `<div><strong>å¹´é½¢åŸºæº– (${age}æ­³):</strong> æ¨å¥¨ ${calcRange(tMin, tMax, unitStr)}</div>`;
                
                if(inputDose) {
                    // V19: Tolerance Â±5%
                    if (inputDose < tMin * 0.95) resultHtml += `<div class="detail-result"><span class="badge-mini bg-red">éå°‘</span> å¹´é½¢åŸºæº–ä¸è¶³</div>`;
                    else if (inputDose > tMax * 1.05) resultHtml += `<div class="detail-result"><span class="badge-mini bg-red">éé‡</span> å¹´é½¢åŸºæº–è¶…é</div>`;
                    else { resultHtml += `<div class="detail-result"><span class="badge-mini bg-green">é©æ­£</span> å¹´é½¢åŸºæº–é©åˆ</div>`; isAgeSafe = true; }
                }
            } else { guideHtml += `<div><strong>å¹´é½¢åŸºæº–:</strong> å¯¾è±¡å¤– (${age}æ­³è¨­å®šãªã—)</div>`; }
        }

        // B: Weight Rule
        const r = rule.rule || (rule.min !== undefined ? rule : null);
        if (r && weight) {
            hasWeightRule = true;
            const unitStr = r.unit === 1 ? "å›" : "æ—¥";
            let minSafe = r.min * weight; let maxSafe = r.max * weight;
            let limitMsg = "";
            if (r.limitDay && r.unit === 0 && maxSafe > r.limitDay) {
                 if (maxSafe > r.limitDay) maxSafe = r.limitDay;
                 if (minSafe > r.limitDay) minSafe = r.limitDay; // Cap min as well (V30 fix)
                 limitMsg = `(ä¸Šé™${r.limitDay})`; 
            }

            guideHtml += `<div><strong>ä½“é‡åŸºæº– (${weight}kg):</strong> ${calcRange(minSafe, maxSafe, unitStr)} ${limitMsg}</div>`;

            if(inputDose) {
                // V19: Tolerance Â±5%
                if (inputDose < minSafe * 0.95) resultHtml += `<div class="detail-result"><span class="badge-mini bg-red">éå°‘</span> ä½“é‡åŸºæº–æœªæº€</div>`;
                else if (inputDose > maxSafe * 1.05) resultHtml += `<div class="detail-result"><span class="badge-mini bg-red">éé‡</span> ä½“é‡åŸºæº–è¶…é</div>`;
                else { resultHtml += `<div class="detail-result"><span class="badge-mini bg-green">é©æ­£</span> ä½“é‡åŸºæº–å†…</div>`; isWeightSafe = true; }
            }
        }

        if(guideHtml) {
            guidelineArea.style.display = "block";
            guidelineArea.innerHTML = guideHtml;
        } else { guidelineArea.style.display = "none"; }

        if (!inputDose) {
            resBox.className = "audit-box audit-check";
            resBox.innerHTML = "ä½“é‡ã¾ãŸã¯å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (å‡¦æ–¹é‡å…¥åŠ›ã§åˆ¤å®š)";
            return;
        }

        let finalSafe = false;
        if (hasAgeRule && hasWeightRule) finalSafe = isAgeSafe || isWeightSafe;
        else if (hasAgeRule) finalSafe = isAgeSafe;
        else if (hasWeightRule) finalSafe = isWeightSafe;

        if (finalSafe) { resBox.className = "audit-box audit-safe"; resBox.innerHTML = `<strong>âœ… åˆ¤å®š: é©æ­£ç¯„å›²å†…</strong> (Â±5%è¨±å®¹)<br>${resultHtml}`; }
        else { resBox.className = "audit-box audit-danger"; resBox.innerHTML = `<strong>âš ï¸ åˆ¤å®š: æ³¨æ„ãŒå¿…è¦</strong><br>${resultHtml}`; }
    }

    // --- ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼ ---
    function parseExcelData() {
        const raw = document.getElementById('pasteArea').value;
        if (!raw.trim()) { alert("ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"); return null; }
        const rows = []; let currentRow = [], currentCell = "", inQuote = false;
        for (let i = 0; i < raw.length; i++) {
            const char = raw[i], nextChar = raw[i+1];
            if (inQuote) { if (char === '"' && nextChar === '"') { currentCell += '"'; i++; } else if (char === '"') { inQuote = false; } else { currentCell += char; } } 
            else { if (char === '"') { inQuote = true; } else if (char === '\t') { currentRow.push(currentCell); currentCell = ""; } else if (char === '\n' || char === '\r') { if (char === '\r' && nextChar === '\n') i++; currentRow.push(currentCell); rows.push(currentRow); currentRow = []; currentCell = ""; } else { currentCell += char; } }
        }
        if (currentCell || currentRow.length > 0) { currentRow.push(currentCell); rows.push(currentRow); }

        const result = [];
        rows.forEach(cols => {
            if (cols.length < 4) return;
            const min = parseFloat(cols[4]), max = parseFloat(cols[5]), flag = parseInt(cols[6]);
            const limit = parseFloat(cols[7]), refsRaw = cols[8] ? cols[8].trim() : "", ageRuleRaw = cols[9] ? cols[9].trim() : "";
            const conc = parseFloat(cols[10]), type = parseInt(cols[11]), groupId = cols[12] ? cols[12].trim() : "";

            let rule = null; if (!isNaN(min) && !isNaN(max) && !isNaN(flag)) rule = { min: min, max: max, unit: flag, limitDay: isNaN(limit) ? null : limit };
            let ageRule = null;
            if (ageRuleRaw) {
                const list = [];
                ageRuleRaw.split(',').forEach(p => {
                    const isKg = p.trim().toLowerCase().endsWith('kg');
                    const cleanP = p.replace(/kg$/i, '');
                    const m = cleanP.match(/([\d\.]+)-([\d\.]+):([\d\.]+)/);
                    if(m) list.push({ start: parseFloat(m[1]), end: parseFloat(m[2]), dose: parseFloat(m[3]), isKg: isKg });
                });
                if(list.length > 0) ageRule = { list: list, unit: !isNaN(flag) ? flag : 0 };
            }
            let refs = refsRaw ? refsRaw.split(/[,ã€\s]+/).map(s => parseInt(s.replace(/\D/g, ''))).filter(n => !isNaN(n)) : [];

            result.push({ name: cols[0].trim(), generic: cols[1].trim(), yomi: cols[2].trim(), text: cols[3].trim(), rule: rule, ageRule: ageRule, refs: refs, conc: !isNaN(conc)?conc:0, type: !isNaN(type)?type:0, groupId: groupId });
        });
        return result;
    }

    function applyLocalData() { const data = parseExcelData(); if(!data) return; dbDrugs = data; localStorage.setItem('pediatric_drug_db', JSON.stringify(data)); document.getElementById('loadingStatusOral').innerHTML = `ğŸ“ ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿é©ç”¨ä¸­ (${data.length}ä»¶)`; alert("ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¾ã—ãŸã€‚"); }
    function downloadJsonFile() { const data = parseExcelData(); if(!data) return; const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'database.json'; a.click(); URL.revokeObjectURL(url); }
    
    // --- è¨ˆç®—å¼ãƒ­ã‚¸ãƒƒã‚¯ ---
    function calcAugsberger() { 
        const ad = parseFloat(document.getElementById('augAdult').value); 
        const wt = parseFloat(document.getElementById('augWeight').value); 
        if (ad && wt) document.getElementById('augResult').textContent = (ad * (wt * 4 + 20) / 100).toFixed(1); 
    }
    
    function calcSchwartz() { 
        const h = parseFloat(document.getElementById('schHeight').value); 
        const cr = parseFloat(document.getElementById('schCr').value); 
        if(h && cr) document.getElementById('schResult').textContent = (0.35 * h / cr).toFixed(1); 
    }
    
    function calcYoung() { 
        const ad = parseFloat(document.getElementById('yngAdult').value); 
        const ag = parseFloat(document.getElementById('yngAge').value); 
        if(ad && ag) document.getElementById('yngResult').textContent = (ad * ag / (ag + 12)).toFixed(1); 
    }
    
    function calcCrawford() { 
        const ad = parseFloat(document.getElementById('crawAdult').value); 
        const ht = parseFloat(document.getElementById('crawHt').value); 
        const wt = parseFloat(document.getElementById('crawWt').value); 
        if(ad && ht && wt) {
            const bsa = 0.007184 * Math.pow(wt, 0.425) * Math.pow(ht, 0.725);
            document.getElementById('crawBSA').textContent = bsa.toFixed(2);
            document.getElementById('crawResult').textContent = (ad * bsa / 1.73).toFixed(1); 
        }
    }
    
    function calcHarnack() {
        const ad = parseFloat(document.getElementById('harAdult').value); 
        const ag = parseFloat(document.getElementById('harAge').value); 
        if (ad && !isNaN(ag)) {
            let ratio = "";
            if (ag < 0.08) ratio = "1/20 - 1/10"; else if (ag < 0.5) ratio = "1/8 - 1/6"; else if (ag < 1) ratio = "1/6 - 1/5"; else if (ag < 3) ratio = "1/5 - 1/4"; else if (ag < 7.5) ratio = "1/4 - 1/3"; else if (ag < 12) ratio = "1/3 - 1/2"; else ratio = "1/2 - 3/4"; const parts = ratio.split('-').map(s => eval(s)); const min = (ad * parts[0]).toFixed(0); const max = (ad * parts[parts.length-1]).toFixed(0); document.getElementById('harResult').textContent = `${min} - ${max}`; } }
    function drawGrowthChart(cid, type) { const w=300, h=250, pad=30; const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg"); svg.setAttribute("width","100%"); svg.setAttribute("height","100%"); svg.setAttribute("viewBox",`0 0 ${w} ${h}`); const d = growthData[type]; const path = document.createElementNS("http://www.w3.org/2000/svg", "path"); path.setAttribute("d",`M${pad},${pad} V${h-pad} H${w-pad}`); path.setAttribute("stroke","#333"); path.setAttribute("stroke-width","1"); path.setAttribute("fill","none"); svg.appendChild(path); 
    // ç›®ç››æç”»
    for(let i=0; i<=12; i+=2) { const x=pad+(i/12)*(w-pad*2); const t=document.createElementNS("http://www.w3.org/2000/svg","text"); t.setAttribute("x",x); t.setAttribute("y",h-10); t.textContent=i; t.setAttribute("font-size","10"); t.setAttribute("text-anchor","middle"); svg.appendChild(t); }
    const labelX=document.createElementNS("http://www.w3.org/2000/svg","text"); labelX.setAttribute("x",w/2); labelX.setAttribute("y",h); labelX.textContent="å¹´é½¢ (æ­³)"; labelX.setAttribute("font-size","11"); labelX.setAttribute("text-anchor","middle"); svg.appendChild(labelX);
    for(let i=0; i<=50; i+=10) { const y=(h-pad)-(i/50)*(h-pad*2); const t=document.createElementNS("http://www.w3.org/2000/svg","text"); t.setAttribute("x",25); t.setAttribute("y",y+3); t.textContent=i; t.setAttribute("font-size","10"); t.setAttribute("text-anchor","end"); svg.appendChild(t); }
    const labelY=document.createElementNS("http://www.w3.org/2000/svg","text"); labelY.setAttribute("x",10); labelY.setAttribute("y",pad-10); labelY.textContent="ä½“é‡ (kg)"; labelY.setAttribute("font-size","11"); labelY.setAttribute("text-anchor","start"); svg.appendChild(labelY);
    for(let i=10; i<=50; i+=10){ const y=(h-pad)-(i/50)*(h-pad*2); const l=document.createElementNS("http://www.w3.org/2000/svg","line"); l.setAttribute("x1",pad); l.setAttribute("x2",w-pad); l.setAttribute("y1",y); l.setAttribute("y2",y); l.setAttribute("stroke","#eee"); l.setAttribute("stroke-dasharray","2,2"); svg.insertBefore(l, path); }
    let lineD = `M`; d.forEach((p,i)=>{ const x=pad+(p[0]/12)*(w-pad*2); const y=(h-pad)-(p[1]/50)*(h-pad*2); lineD+=`${i===0?'':','}${x} ${y}`; const c=document.createElementNS("http://www.w3.org/2000/svg", "circle"); c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r",2); c.setAttribute("fill",type==='boy'?'#3498db':'#e74c3c'); svg.appendChild(c); }); const line = document.createElementNS("http://www.w3.org/2000/svg", "polyline"); line.setAttribute("points",lineD.replace(/M/,'')); line.setAttribute("stroke",type==='boy'?'#3498db':'#e74c3c'); line.setAttribute("stroke-width","2"); line.setAttribute("fill","none"); svg.appendChild(line); document.getElementById(cid).appendChild(svg); }
    function drawGrowthTable() { const c = document.getElementById('growthTableContainer'); let h = '<table class="common-table"><thead><tr><th>å¹´é½¢</th>'; growthData.boy.forEach(p=>h+=`<th>${p[0]}</th>`); h+='</tr></thead><tbody><tr><th>ç”·å­</th>'; growthData.boy.forEach(p=>h+=`<td>${p[1]}</td>`); h+='</tr><tr><th>å¥³å­</th>'; growthData.girl.forEach(p=>h+=`<td>${p[1]}</td>`); h+='</tr></tbody></table>'; c.innerHTML = h; }
</script>
</body>
</html>
