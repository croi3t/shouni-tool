<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å…ç”¨é‡ç›£æŸ»ãƒ„ãƒ¼ãƒ« V8 (å®‰å…¨æ€§å¼·åŒ–ç‰ˆ)</title>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #c0392b; --warning: #f39c12; --bg: #f4f7f6; --text: #333; }
        body { font-family: "Meiryo", "Hiragino Kaku Gothic ProN", sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); line-height: 1.6; }
        header { background: var(--primary); color: #fff; padding: 15px 0; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.4rem; }
        
        /* ã‚¿ãƒ– */
        .tab-nav { display: flex; justify-content: center; background: #34495e; padding: 0; list-style: none; margin: 0; }
        .tab-nav li { cursor: pointer; padding: 12px 20px; color: #bdc3c7; transition: 0.3s; border-bottom: 4px solid transparent; font-weight: bold; font-size: 0.95rem; }
        .tab-nav li:hover { color: #fff; background: #3e5871; }
        .tab-nav li.active { color: #fff; border-bottom-color: var(--accent); background: #2c3e50; }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; }
        .tab-content { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ç›£æŸ»ãƒ„ãƒ¼ãƒ« */
        .panel { background: #eef2f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dce4ec; }
        .row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .col { flex: 1; min-width: 180px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--primary); font-size: 0.95rem; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; transition: all 0.3s; }
        input:disabled { background: #e9ecef; }
        
        /* å¹´é½¢å…¥åŠ›èª˜å°ç”¨ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes alertPulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); border-color: #e74c3c; }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); border-color: #e74c3c; }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); border-color: #e74c3c; }
        }
        .input-alert { animation: alertPulse 1.5s infinite; background-color: #fff5f5; }

        /* æ¤œç´¢ãƒªã‚¹ãƒˆ */
        .search-container { position: relative; }
        #drugList { list-style: none; padding: 0; margin: 0; position: absolute; width: 100%; max-height: 300px; overflow-y: auto; background: #fff; border: 1px solid #ddd; z-index: 100; display: none; box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        #drugList li { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 16px; }
        #drugList li:hover { background: #e6f7ff; color: var(--accent); }

        /* ã‚·ãƒŠãƒªã‚ªé¸æŠ */
        .scenario-selector { margin-bottom: 20px; background: #fff8e1; padding: 15px; border: 1px solid #ffe082; border-radius: 6px; }
        .scenario-title { font-weight: bold; color: #f39c12; margin-bottom: 10px; display: block; }
        .scenario-opt { display: block; margin-bottom: 8px; cursor: pointer; font-weight: bold; font-size: 0.95rem; }

        /* â˜…V8æ–°è¨­: è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
        #safetyAlertArea { display: none; margin-bottom: 20px; padding: 15px; border-radius: 6px; border-left: 6px solid; font-weight: bold; line-height: 1.5; }
        .safety-danger { background: #fee; border-color: #c0392b; color: #c0392b; }
        .safety-warning { background: #fff3cd; border-color: #f39c12; color: #856404; }

        /* çµæœã‚«ãƒ¼ãƒ‰ */
        #resultCard { display: none; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff; margin-top: 20px; }
        .card-header { background: var(--primary); color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 20px; }

        .audit-box { padding: 20px; border-radius: 6px; border-left: 6px solid #ccc; background: #f9f9f9; margin-bottom: 25px; font-size: 1.1rem; }
        .audit-safe { background: #e8f5e9; border-left-color: var(--success); color: #1b5e20; }
        .audit-danger { background: #fbe9e7; border-left-color: var(--danger); color: #b71c1c; }
        .audit-check { background: #fff3e0; border-left-color: var(--warning); color: #e65100; }

        .original-text { background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; color: #444; line-height: 1.8; font-family: inherit; white-space: pre-wrap; word-wrap: break-word; word-break: break-all; }
        .dose-label { font-size: 0.9rem; background: #fff; padding: 4px 10px; border-radius: 15px; color: var(--primary); font-weight: bold; }
        .ref-links a { display: inline-block; margin-right: 15px; margin-bottom: 8px; color: var(--accent); text-decoration: none; background: #f0f8ff; padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; }
        .ref-nolink { display: inline-block; margin-right: 15px; margin-bottom: 8px; color: #666; background: #f5f5f5; padding: 6px 12px; border-radius: 20px; border: 1px solid #ddd; font-size: 0.9rem; }

        /* è³‡æ–™ãƒ»è¨­å®šã‚¿ãƒ– */
        h2 { border-left: 5px solid var(--accent); padding-left: 10px; color: var(--primary); margin-top: 30px; font-size: 1.3rem; }
        .chart-container { width: 100%; height: 350px; position: relative; margin-bottom: 20px; border: 1px solid #eee; }
        .formula-box { background: #fdfdfd; border: 1px solid #eee; padding: 15px; border-radius: 5px; margin-bottom: 15px; height: 100%; }
        .formula-title { font-weight: bold; color: var(--accent); margin-bottom: 5px; }
        .formula-math { font-family: "Times New Roman", serif; font-size: 1.2rem; background: #eee; padding: 10px; text-align: center; border-radius: 4px; margin: 10px 0; }
        table.common-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; margin-top: 10px; }
        table.common-table th, table.common-table td { border: 1px solid #ddd; padding: 8px 5px; text-align: center; }
        table.common-table th { background: #f2f2f2; color: var(--primary); font-weight: bold; }
        table.common-table tr:nth-child(even) td { background: #fafafa; }
        #growthTableContainer { overflow-x: auto; margin-bottom: 30px; }
        #growthTableContainer table { min-width: 600px; }
        #growthTableContainer th:first-child, #growthTableContainer td:first-child { background: #eef2f5; font-weight: bold; width: 80px; position: sticky; left: 0; z-index: 10; border-right: 2px solid #ddd; }
        .harnack-table th { text-align: left; padding-left: 15px; width: 40%; }
        .harnack-table td { text-align: left; padding-left: 15px; }
        .btn-action { color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-action:hover { opacity: 0.9; }
        .data-status { margin-top: 15px; font-weight: bold; text-align: center; color: var(--primary); }
        #errorBanner { display:none; background:#ffdddd; color:red; padding:15px; border:1px solid red; margin:10px; font-weight:bold; }
    </style>
    
    <script>
        function switchTab(id) {
            try {
                document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.tab-nav li').forEach(e => e.classList.remove('active'));
                const target = document.getElementById(id); if(target) target.classList.add('active');
                const idx = {'tab-calc':0, 'tab-knowledge':1, 'tab-settings':2}[id];
                const navItems = document.querySelectorAll('.tab-nav li'); if(navItems[idx]) navItems[idx].classList.add('active');
            } catch(e) { console.error("Tab Error:", e); }
        }
        window.onerror = function(msg, url, line) {
            const banner = document.getElementById('errorBanner');
            if(banner) { banner.style.display = 'block'; banner.innerHTML = `âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: ${msg} (Line: ${line})`; }
        };
    </script>
</head>
<body>

<header>
    <h1>ğŸ’Š å°å…ç”¨é‡ç›£æŸ»ãƒ„ãƒ¼ãƒ« V8</h1>
</header>

<div id="errorBanner"></div>

<ul class="tab-nav">
    <li class="active" onclick="switchTab('tab-calc')">ç›£æŸ»ãƒ»è¨ˆç®—</li>
    <li onclick="switchTab('tab-knowledge')">è³‡æ–™ãƒ»çŸ¥è­˜</li>
    <li onclick="switchTab('tab-settings')">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</li>
</ul>

<div class="container">
    <div id="tab-calc" class="tab-content active">
        <div id="loadingStatus" style="text-align:center; padding:10px; color:#666; font-size:0.9rem;">â³ æº–å‚™ä¸­...</div>
        
        <div id="safetyAlertArea"></div>

        <div class="panel">
            <div class="row">
                <div class="col search-container" style="flex: 2; min-width: 100%;">
                    <label>è–¬å‰¤æ¤œç´¢</label>
                    <input type="text" id="searchBox" placeholder="ä¾‹ï¼šã‚¿ãƒŸãƒ•ãƒ«ã€ãƒŸãƒã‚µã‚¤ã‚¯ãƒªãƒ³..." autocomplete="off">
                    <ul id="drugList"></ul>
                </div>
            </div>
            <div class="row">
                <div class="col"><label>ä½“é‡ (kg)</label><input type="number" id="weight" step="0.1" placeholder="ä¾‹: 15.5" oninput="runAudit()"></div>
                <div class="col"><label>å¹´é½¢ (æ­³)</label><input type="number" id="age" step="0.1" placeholder="ä¾‹: 3" oninput="runAudit()"></div>
                <div class="col"><label id="doseLabel">å‡¦æ–¹é‡</label><input type="number" id="doseInput" placeholder="å…¥åŠ›" oninput="runAudit()" disabled></div>
            </div>
        </div>
        
        <div id="scenarioArea" class="scenario-selector" style="display:none;">
            <span class="scenario-title">ğŸ“Œ é©å¿œãƒ»å¹´é½¢åŒºåˆ†ã‚’é¸æŠã—ã¦ãã ã•ã„:</span>
            <div id="scenarioOptions"></div>
        </div>

        <div id="resultCard">
            <div class="card-header">
                <div><span id="resName" style="font-weight:bold; font-size:1.2rem;"></span><span id="resGeneric" style="font-size:0.9rem; margin-left:10px; opacity:0.9;"></span></div>
                <span id="auditTypeBadge" class="dose-label"></span>
            </div>
            <div class="card-body">
                <div id="auditResult" class="audit-box audit-check"></div>
                <div style="margin-bottom:8px; font-weight:bold; color:var(--primary);">ç”¨æ³•ãƒ»ç”¨é‡ï¼ˆå°å…ï¼‰åŸæ–‡:</div>
                <div id="resPedsText" class="original-text"></div>
                <div id="refArea" style="margin-top:20px; display:none;">
                    <div style="margin-bottom:8px; font-weight:bold; color:#666;">ğŸ“š å‚è€ƒæ–‡çŒ®:</div>
                    <div id="refLinksContainer" class="ref-links"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-knowledge" class="tab-content">
        <h2>ğŸ“Š èº«ä½“ç™ºè‚²æ›²ç·š</h2>
        <div class="row">
            <div class="col"><h3 style="text-align:center; color:#e74c3c;">å¥³å­</h3><div id="chartGirl" class="chart-container"></div></div>
            <div class="col"><h3 style="text-align:center; color:#3498db;">ç”·å­</h3><div id="chartBoy" class="chart-container"></div></div>
        </div>
        <div id="growthTableContainer"></div>
        <h2>ğŸ§® è¨ˆç®—å¼</h2>
        <div class="formula-box" style="margin-bottom:20px;">
            <div class="formula-title">Augsbergerå¼ II</div>
            <div class="formula-math">å°å…é‡ = æˆäººé‡ Ã— ( ä½“é‡ Ã— 4 + 20 ) / 100</div>
            <div style="background:#f0f0f0; padding:10px;">
                æˆäºº: <input type="number" id="augAdult" style="width:70px;">mg Ã— ä½“é‡: <input type="number" id="augWeight" style="width:70px;">kg 
                <button onclick="calcAugsberger()">è¨ˆç®—</button> = <span id="augResult">---</span>mg
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="formula-box"><div class="formula-title">Von Harnackè¡¨</div><table class="common-table harnack-table"><tr><th>æœªç†Ÿå…</th><td>1/20 ï½ 1/10</td></tr><tr><th>æ–°ç”Ÿå…</th><td>1/10 ï½ 1/8</td></tr><tr><th>ä¹³å…(~6M)</th><td>1/8 ï½ 1/6</td></tr><tr><th>ä¹³å…(6M~)</th><td>1/6 ï½ 1/5</td></tr><tr><th>å¹¼å…(1-3)</th><td>1/5 ï½ 1/4</td></tr><tr><th>å¹¼å…(3-7.5)</th><td>1/4 ï½ 1/3</td></tr><tr><th>å­¦ç«¥(7.5-12)</th><td>1/3 ï½ 1/2</td></tr><tr><th>å­¦ç«¥(12~)</th><td>1/2 ï½ 3/4</td></tr></table></div>
            </div>
            <div class="col">
                <div class="formula-box"><div class="formula-title">Young / Crawford</div><div style="font-size:0.9rem;">Young: æˆäººé‡ Ã— å¹´é½¢ / (å¹´é½¢+12)</div><hr style="border:0; border-top:1px solid #ddd; margin:15px 0;"><div style="font-size:0.9rem;">Crawford: æˆäººé‡ Ã— ä½“è¡¨é¢ç©(mÂ²) / 1.73</div></div>
            </div>
        </div>
    </div>

    <div id="tab-settings" class="tab-content">
        <h2>ğŸ› ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†</h2>
        <p>Excelãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€ãƒ†ã‚¹ãƒˆã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã‚’è¡Œã„ã¾ã™ã€‚</p>
        <div style="background:#e3f2fd; padding:15px; border-left:5px solid #2196f3; margin-bottom:15px; font-size:0.9rem;"><strong>ğŸ“ Excelè²¼ã‚Šä»˜ã‘åˆ—é † (å…¨10åˆ—):</strong><br>[1]å•†å“ [2]ä¸€èˆ¬ [3]ã‚ˆã¿ [4]æ–‡ [5]æœ€å° [6]æœ€å¤§ [7]å˜ä½ [8]ä¸Šé™ [9]å‚ç…§ [10]å¹´é½¢å›ºå®šãƒ«ãƒ¼ãƒ«</div>
        <textarea id="pasteArea" rows="12" placeholder="ã“ã“ã«Excelã‚’è²¼ã‚Šä»˜ã‘..."></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-action" style="background:#27ae60;" onclick="applyLocalData()">â–¶ï¸ ãƒ†ã‚¹ãƒˆåæ˜  (ã“ã®å ´ã ã‘ã§ç¢ºèª)</button>
            <button class="btn-action" style="background:#2980b9;" onclick="downloadJsonFile()">â¬‡ï¸ JSONä½œæˆ (GitHubç”¨)</button>
        </div>
        <div id="saveStatus" class="data-status"></div>
    </div>
</div>

<script>
    // â– â– â–  ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã‚¨ãƒªã‚¢: ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«ãƒ»ã‚·ãƒŠãƒªã‚ª â– â– â– 
    const specialDrugRules = {
        "ã‚¿ãƒŸãƒ•ãƒ«": [
            { label: "æ²»ç™‚ (1æ­³æœªæº€): 6mg/kg/æ—¥", rule: { min:6, max:6, unit:0 } },
            { label: "æ²»ç™‚ (1æ­³ä»¥ä¸Š): 4mg/kg/æ—¥ (ä¸Šé™150mg)", rule: { min:4, max:4, unit:0, limitDay:150 } },
            { label: "äºˆé˜²: 2mg/kg/æ—¥ (ä¸Šé™75mg)", rule: { min:2, max:2, unit:0, limitDay:75 } }
        ],
        "ã‚ªã‚»ãƒ«ã‚¿ãƒŸãƒ“ãƒ«": [
            { label: "æ²»ç™‚ (1æ­³æœªæº€): 6mg/kg/æ—¥", rule: { min:6, max:6, unit:0 } },
            { label: "æ²»ç™‚ (1æ­³ä»¥ä¸Š): 4mg/kg/æ—¥ (ä¸Šé™150mg)", rule: { min:4, max:4, unit:0, limitDay:150 } },
            { label: "äºˆé˜²: 2mg/kg/æ—¥ (ä¸Šé™75mg)", rule: { min:2, max:2, unit:0, limitDay:75 } }
        ],
        "ãƒ‡ã‚«ãƒ‰ãƒ­ãƒ³": [
            { label: "æ°—ç®¡æ”¯å–˜æ¯: 0.2-0.3mg/kg/å›", rule: { min:0.2, max:0.3, unit:1 } },
            { label: "ã‚¯ãƒ«ãƒ¼ãƒ—: 0.15-0.6mg/kg/å›", rule: { min:0.15, max:0.6, unit:1 } },
            { label: "å…ˆå¤©æ€§å‰¯è…éå½¢æˆ: 0.5mg/æ—¥(å›ºå®š)", ageRule: { list:[{start:0, end:100, dose:0.5}], unit:0 } }
        ],
        "ãƒ‡ã‚­ã‚µãƒ¡ã‚¿ã‚¾ãƒ³": [
            { label: "æ°—ç®¡æ”¯å–˜æ¯: 0.2-0.3mg/kg/å›", rule: { min:0.2, max:0.3, unit:1 } },
            { label: "ã‚¯ãƒ«ãƒ¼ãƒ—: 0.15-0.6mg/kg/å›", rule: { min:0.15, max:0.6, unit:1 } },
            { label: "å…ˆå¤©æ€§å‰¯è…éå½¢æˆ: 0.5mg/æ—¥(å›ºå®š)", ageRule: { list:[{start:0, end:100, dose:0.5}], unit:0 } }
        ]
    };

    // â– â– â–  V8æ–°è¨­: è¦æ³¨æ„è–¬å‰¤ãƒªã‚¹ãƒˆ (éƒ¨åˆ†ä¸€è‡´ã§åˆ¤å®š) â– â– â– 
    const drugWarnings = [
        { key: "ãƒŸãƒã‚µã‚¤ã‚¯ãƒªãƒ³", limitAge: 8, msg: "âš ï¸ã€8æ­³æœªæº€ åŸå‰‡ç¦å¿Œã€‘æ­¯ç‰™é»„æŸ“ãƒ»ã‚¨ãƒŠãƒ¡ãƒ«è³ªå½¢æˆä¸å…¨ã€éª¨ç™ºè‚²ä¸å…¨ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚<br>ä»–å‰¤ãŒç„¡åŠ¹ã¾ãŸã¯ä½¿ç”¨ã§ããªã„å ´åˆã«ã®ã¿é©ç”¨ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚" },
        { key: "ã‚¢ã‚¹ãƒ”ãƒªãƒ³", limitAge: 15, msg: "âš ï¸ã€15æ­³æœªæº€ (æ°´ç—˜ãƒ»ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶ç™ºç—‡æ‚£è€…)ã€‘ãƒ©ã‚¤ç—‡å€™ç¾¤ã®ç™ºç—‡ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ãŸã‚åŸå‰‡ç¦å¿Œã§ã™ã€‚" },
        { key: "ãƒ”ãƒ¬ãƒã‚¢", limitAge: 2, msg: "âš ï¸ã€2æ­³æœªæº€ ç¦å¿Œã€‘å‘¼å¸æŠ‘åˆ¶ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚" },
        { key: "ãƒ—ãƒ­ãƒ¡ã‚¿ã‚¸ãƒ³", limitAge: 2, msg: "âš ï¸ã€2æ­³æœªæº€ ç¦å¿Œã€‘å‘¼å¸æŠ‘åˆ¶ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚" },
        { key: "ãƒ¬ãƒœãƒ•ãƒ­ã‚­ã‚µã‚·ãƒ³", limitAge: 18, msg: "âš ï¸ã€å°å…ã€‘é–¢ç¯€éšœå®³ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚æœ‰ç›Šæ€§ãŒä¸Šå›ã‚‹å ´åˆã®ã¿æŠ•ä¸ã—ã¦ãã ã•ã„ã€‚" },
        { key: "ãƒˆã‚¹ãƒ•ãƒ­ã‚­ã‚µã‚·ãƒ³", limitAge: 18, msg: "âš ï¸ã€å°å…ã€‘é–¢ç¯€éšœå®³ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚æœ‰ç›Šæ€§ãŒä¸Šå›ã‚‹å ´åˆã®ã¿æŠ•ä¸ã—ã¦ãã ã•ã„ã€‚" }
    ];

    let dbDrugs = [];
    let currentRule = null;
    let currentWarning = null; // ç¾åœ¨è¡¨ç¤ºä¸­ã®è­¦å‘Š

    const dbRefs = { 1: { title: "æ·»ä»˜æ–‡æ›¸", url: "" }, 2: { title: "æ–°å°å…è–¬é‡é‡", url: "" }, 3: { title: "å…ˆå¤©æ€§å¿ƒç–¾æ‚£ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³(2018)", url: "https://www.j-circ.or.jp/cms/wp-content/uploads/2020/02/JCS2018_Yasukochi.pdf" }, 4: { title: "å°å…çµæ ¸è¨ºç™‚ã®ã¦ã³ã", url: "https://jata.or.jp/wp-content/uploads/2025/04/shouni_tebiki_202504.pdf" }, 5: { title: "Official American Thoracic Society/CDC/IDSA", url: "https://academic.oup.com/cid/article/63/7/e147/2196792" }, 6: { title: "æ–°ç”Ÿå…ãƒã‚¹ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰", url: "https://jsimd.net/pdf/newborn-mass-screening-disease-practice-guideline2019_v2.pdf" }, 7: { title: "ãƒã‚¯ãƒ­ãƒ©ã‚¤ãƒ‰ç³»æŠ—ç”Ÿç‰©è³ªã®æ–°ã—ã„å±•é–‹", url: "https://search.jamas.or.jp/default/link?pub_year=2000&ichushi_jid=J01816&link_issn=&doc_id=20001128020009&doc_link_id=%2Fac3rbbtb%2F2000%2F002706%2F009%2F0839-0842%26dl%3D0&url=https%3A%2F%2Fwww.medicalonline.jp%2Fjamas.php%3FGoodsID%3D%2Fac3rbbtb%2F2000%2F002706%2F009%2F0839-0842%26dl%3D0&type=MedicalOnline&icon=https%3A%2F%2Fjk04.jamas.or.jp%2Ficon%2F00004_2.gif" }, 8: { title: "ä»Šæ—¥ã®æ²»ç™‚æŒ‡é‡2025ï¼è†€èƒ±å°¿ç®¡é€†æµ", url: "" }, 9: { title: "Medspace", url: "https://reference.medscape.com/drug/valium-valtoco-diazepam-342902" }, 10: { title: "æœªæ‰¿èªè–¬ãƒ»é©å¿œå¤–è–¬ã®è¦æœ›", url: "https://www.mhlw.go.jp/topics/2012/03/dl/kigyoukenkai-160.pdf" }, 11: { title: "JAID/JSC æ„ŸæŸ“ç—‡æ²»ç™‚ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³", url: "https://www.chemotherapy.or.jp/uploads/files/guideline/jaidjsc-kansenshochiryo_nyouro.pdf" }, 12: { title: "å°å…æ°—ç®¡æ”¯å–˜æ¯æ²»ç™‚ãƒ»ç®¡ç†ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³", url: "" }, 13: { title: "UpToDate æ€¥æ€§å–˜æ¯å¢—æ‚ª", url: "https://www.uptodate.com/contents/acute-asthma-exacerbations-in-children-younger-than-12-years-emergency-department-management" }, 14: { title: "UpToDate å…ˆå¤©æ€§å‰¯è…éå½¢æˆ", url: "https://www.uptodate.com/contents/classic-congenital-adrenal-hyperplasia-due-to-21-hydroxylase-deficiency-in-infants-and-children-treatment" }, 15: { title: "è»½ç—‡èƒƒè…¸ç‚é–¢é€£ã‘ã„ã‚Œã‚“ã«å¯¾ã™ã‚‹carbamazepine", url: "https://www.jstage.jst.go.jp/article/ojjscn1969/37/6/37_6_493/_pdf/-char/ja" }, 16: { title: "ä»Šæ—¥ã®å°å…æ²»ç™‚æŒ‡é‡17ç‰ˆ>VitDæ¬ ä¹", url: "" }, 17: { title: "ä»Šæ—¥ã®å°å…æ²»ç™‚æŒ‡é‡17ç‰ˆ>æ–°ç”Ÿå…ä½Ca", url: "" }, 18: { title: "ä»Šæ—¥ã®å°å…æ²»ç™‚æŒ‡é‡17ç‰ˆ>æ€¥æ€§ä¸‹ç—¢", url: "" }, 19: { title: "æ–°ç”Ÿå…è¨ºç™‚ãƒãƒ‹ãƒ¥ã‚¢ãƒ«", url: "" }, 20: { title: "å‘¨ç”£æœŸåŒ»å­¦ 50 (å¢—åˆŠ) 2020", url: "https://mol.medicalonline.jp/library/journal/download?GoodsID=aq9syuse/2020/0050s1/138&name=0588-0591j" }, 21: { title: "åŒ»å¸«ã®ã¿é–²è¦§å¯èƒ½ãƒãƒ‹ãƒ¥ã‚¢ãƒ«", url: "" }, 22: { title: "å°å…å¿ƒä¸å…¨è–¬ç‰©æ²»ç™‚ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³", url: "https://jpccs.jp/10.9794/jspccs.31.S2_1/data/index.html" }, 23: { title: "ä»Šæ—¥ã®æ²»ç™‚æŒ‡é‡2024>ä¾¿ç§˜", url: "" }, 24: { title: "ä»Šæ—¥ã®å°å…æ²»ç™‚æŒ‡é‡17ç‰ˆ>ã‚¦ã‚¤ãƒ«ã‚¹æ€§èƒƒè…¸ç‚", url: "" }, 25: { title: "å°å…ç§‘ã§ã™ãã«æˆ¦ãˆã‚‹ãƒ›ã‚³ã¨ã‚¿ãƒ†", url: "" }, 26: { title: "ä¹³å…èƒƒé£Ÿé“é€†æµ å…­å›å­æ¹¯", url: "https://www.jstage.jst.go.jp/article/jjsps/52/2/52_243/_pdf/-char/ja" }, 27: { title: "ä»Šæ—¥ã®å°å…æ²»ç™‚æŒ‡é‡17ç‰ˆ>èƒƒé£Ÿé“é€†æµ", url: "" }, 28: { title: "å‘¨ç”£æœŸåŒ»å­¦ 50 (å¢—åˆŠ) 458-462", url: "https://mol.medicalonline.jp/library/journal/download?GoodsID=aq9syuse/2020/0050s1/106&name=0458-0462j" }, 29: { title: "ãƒ„ãƒ ãƒ©MEDICAL SITE", url: "https://medical.tsumura.co.jp/support/knowledge/20221104_2.html" }, 30: { title: "å…¬çŸ¥ç”³è«‹ã¸ã®è©²å½“æ€§ã«ä¿‚ã‚‹å ±å‘Šæ›¸", url: "https://www.mhlw.go.jp/stf/shingi/2r9852000000ti7f-att/2r9852000000tie2.pdf" }, 31: { title: "æ–°ç”Ÿå…é‰„å‰¤æŠ•ä¸ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³", url: "http://jsnhd.or.jp/pdf/31-1-159-185.pdf" }, 32: { title: "IWK Health Neonatal Guidelines", url: "https://www.dir.iwk.nshealth.ca/Home/DDGDetails/46d8310f-1d91-e911-80f2-005056b200d2?PatientPopulation=Neo" } };

    window.onload = function() {
        try {
            drawGrowthChart('chartGirl', 'girl');
            drawGrowthChart('chartBoy', 'boy');
            drawGrowthTable();
            
            fetch('./database.json').then(r => r.json()).then(d => {
                dbDrugs = d;
                document.getElementById('loadingStatus').innerHTML = `âœ… DBæ¥ç¶šå®Œäº† (${d.length}ä»¶)`;
                document.getElementById('loadingStatus').style.color = "green";
            }).catch(e => {
                const local = localStorage.getItem('pediatric_drug_db');
                if(local){
                    dbDrugs = JSON.parse(local);
                    document.getElementById('loadingStatus').innerHTML = `âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ (${dbDrugs.length}ä»¶)`;
                } else {
                    document.getElementById('loadingStatus').innerHTML = `â„¹ï¸ ãƒ‡ãƒ¼ã‚¿æœªç™»éŒ²`;
                }
            });
        } catch(e){ console.error("Init:", e); }
    };

    function switchTab(id){
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-nav li').forEach(e=>e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const idx={'tab-calc':0,'tab-knowledge':1,'tab-settings':2}[id];
        document.querySelectorAll('.tab-nav li')[idx].classList.add('active');
    }

    const searchBox = document.getElementById('searchBox');
    const drugList = document.getElementById('drugList');
    
    searchBox.addEventListener('keyup', (e) => {
        const val = e.target.value.toLowerCase().replace(/\s+/g, '');
        if (!val) { drugList.style.display = 'none'; return; }
        drugList.innerHTML = '';
        const hits = dbDrugs.filter(d => 
            (d.name && d.name.toLowerCase().includes(val)) || (d.generic && d.generic.toLowerCase().includes(val)) || (d.yomi && d.yomi.replace(/\s+/g, '').includes(val))
        );
        if (hits.length > 0) {
            drugList.style.display = 'block';
            hits.forEach(d => {
                const li = document.createElement('li');
                li.textContent = `${d.name} (${d.generic})`;
                li.onclick = () => selectDrug(d);
                drugList.appendChild(li);
            });
        } else { drugList.style.display = 'none'; }
    });

    function selectDrug(drug) {
        searchBox.value = drug.name;
        drugList.style.display = 'none';
        document.getElementById('doseInput').disabled = false;
        document.getElementById('resultCard').style.display = 'block';
        document.getElementById('resName').textContent = drug.name;
        document.getElementById('resGeneric').textContent = drug.generic;
        document.getElementById('resPedsText').textContent = drug.text;

        // V8: è­¦å‘Šãƒã‚§ãƒƒã‚¯
        currentWarning = null;
        const alertArea = document.getElementById('safetyAlertArea');
        alertArea.style.display = "none";
        
        for (const w of drugWarnings) {
            if (drug.name.includes(w.key) || drug.generic.includes(w.key)) {
                currentWarning = w;
                alertArea.innerHTML = w.msg;
                alertArea.className = "safety-warning"; // åˆæœŸã¯é»„è‰²
                alertArea.style.display = "block";
                
                // å¹´é½¢å…¥åŠ›ã‚’ä¿ƒã™
                document.getElementById('age').classList.add('input-alert');
                break; 
            }
        }
        if(!currentWarning) {
            document.getElementById('age').classList.remove('input-alert');
        }

        // ã‚·ãƒŠãƒªã‚ªåˆ¤å®š
        const scenarioDiv = document.getElementById('scenarioArea');
        const optsDiv = document.getElementById('scenarioOptions');
        optsDiv.innerHTML = '';
        let scenarios = null;
        for (const [key, list] of Object.entries(specialDrugRules)) {
            if (drug.name.includes(key) || drug.generic.includes(key)) { scenarios = list; break; }
        }

        if (scenarios) {
            scenarioDiv.style.display = 'block';
            scenarios.forEach((s, idx) => {
                const label = document.createElement('label');
                label.className = "scenario-opt";
                label.innerHTML = `<input type="radio" name="scenario" value="${idx}" ${idx===0?'checked':''}> ${s.label}`;
                label.onchange = () => { applyRule(s); runAudit(); };
                optsDiv.appendChild(label);
            });
            applyRule(scenarios[0]);
        } else {
            scenarioDiv.style.display = 'none';
            applyRule(drug);
        }
        
        // å‚ç…§
        const refDiv = document.getElementById('refLinksContainer');
        refDiv.innerHTML = '';
        document.getElementById('refArea').style.display = (drug.refs && drug.refs.length > 0) ? 'block' : 'none';
        if(drug.refs) drug.refs.forEach(id => {
            const d = dbRefs[id];
            const a = document.createElement('a');
            a.textContent = `[${id}] ${d ? d.title : 'æ–‡çŒ®'}`;
            if (d && d.url) { a.href = d.url; a.target = "_blank"; } else { a.className = 'ref-nolink'; }
            refDiv.appendChild(a);
        });
        runAudit();
    }

    function applyRule(data) {
        currentRule = data;
        const badge = document.getElementById('auditTypeBadge');
        const doseLabel = document.getElementById('doseLabel');
        let unit = 0;
        if (data.ageRule) unit = data.ageRule.unit; else if (data.rule) unit = data.rule.unit;

        if (data.ageRule || data.rule) {
            if (unit === 1) {
                doseLabel.textContent = "å‡¦æ–¹é‡ (1å›é‡ mg)";
                badge.textContent = "åŸºæº–: 1å›é‡"; badge.style.background = "#fff3cd"; badge.style.color = "#856404";
            } else {
                doseLabel.textContent = "å‡¦æ–¹é‡ (1æ—¥ç·é‡ mg)";
                badge.textContent = "åŸºæº–: 1æ—¥ç·é‡"; badge.style.background = "#d1ecf1"; badge.style.color = "#0c5460";
            }
        } else {
            doseLabel.textContent = "å‡¦æ–¹é‡ (åˆ¤å®šä¸å¯)";
            badge.textContent = "ç›®è¦–ã®ã¿"; badge.style.background = "#e2e3e5"; badge.style.color = "#383d41";
        }
    }

    function runAudit() {
        const resBox = document.getElementById('auditResult');
        const alertArea = document.getElementById('safetyAlertArea');
        const weight = parseFloat(document.getElementById('weight').value);
        const age = parseFloat(document.getElementById('age').value);
        const inputDose = parseFloat(document.getElementById('doseInput').value);

        // V8: å¹´é½¢è­¦å‘Šã®æ›´æ–°
        if (currentWarning) {
            if (!isNaN(age) && age < currentWarning.limitAge) {
                alertArea.className = "safety-danger"; // èµ¤ãã™ã‚‹
                document.getElementById('age').classList.remove('input-alert'); // ç‚¹æ»…è§£é™¤
            } else if (!isNaN(age)) {
                alertArea.className = "safety-warning"; // å¹´é½¢OKãªã‚‰é»„è‰²(æ³¨æ„å–šèµ·ã®ã¿)
                document.getElementById('age').classList.remove('input-alert');
            } else {
                // å¹´é½¢æœªå…¥åŠ›
                document.getElementById('age').classList.add('input-alert');
            }
        } else {
            document.getElementById('age').classList.remove('input-alert');
        }

        if (!currentRule) return;

        // å¹´é½¢å›ºå®šãƒ«ãƒ¼ãƒ«å„ªå…ˆ
        if (currentRule.ageRule && !isNaN(age)) {
            const ar = currentRule.ageRule;
            const unitStr = ar.unit === 1 ? "å›" : "æ—¥";
            const match = ar.list.find(r => age >= r.start && age < r.end);
            if (match) {
                const t = match.dose;
                if (!inputDose) { resBox.className = "audit-box audit-check"; resBox.innerHTML = `<strong>å¹´é½¢ç”¨é‡:</strong> æ¨å¥¨ <strong>${t} mg/${unitStr}</strong>`; return; }
                const ratio = inputDose / t;
                if (ratio < 0.8) { resBox.className="audit-box audit-danger"; resBox.innerHTML=`<strong>ğŸ”½ éå°‘</strong><br>å…¥åŠ›: ${inputDose}mg < æ¨å¥¨: ${t}mg`; }
                else if (ratio > 1.2) { resBox.className="audit-box audit-danger"; resBox.innerHTML=`<strong>ğŸ”¼ éé‡</strong><br>å…¥åŠ›: ${inputDose}mg > æ¨å¥¨: ${t}mg`; }
                else { resBox.className="audit-box audit-safe"; resBox.innerHTML=`<strong>âœ… é©æ­£ç¯„å›²å†…</strong><br>${age}æ­³ã®æ¨å¥¨é‡ (${t}mg) ã«é©åˆ`; }
                return;
            }
        }

        // ä½“é‡ãƒ«ãƒ¼ãƒ«
        if (!currentRule.rule) {
            resBox.className = "audit-box audit-check"; resBox.innerHTML = `<strong>âš ï¸ è‡ªå‹•åˆ¤å®šä¸å¯</strong><br><small>åŸæ–‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</small>`; return;
        }
        const r = currentRule.rule;
        const unitStr = r.unit === 1 ? "å›" : "æ—¥";
        if (!weight || !inputDose) {
            resBox.className = "audit-box audit-check";
            if(weight) resBox.innerHTML = `<strong>ç›®å®‰:</strong> ${weight}kg â†’ <strong>${(r.min*weight).toFixed(2)}ï½${(r.max*weight).toFixed(2)} mg/${unitStr}</strong>`;
            else resBox.innerHTML = "ä½“é‡ã¨å‡¦æ–¹å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
            return;
        }
        let minSafe = r.min * weight;
        let maxSafe = r.max * weight;
        let limitMsg = "";
        if (r.limitDay && r.unit === 0 && maxSafe > r.limitDay) { maxSafe = r.limitDay; limitMsg = ` (ä¸Šé™: ${r.limitDay}mg)`; }

        if (inputDose < minSafe) { resBox.className="audit-box audit-danger"; resBox.innerHTML=`<strong>ğŸ”½ éå°‘</strong><br>å…¥åŠ›: ${inputDose}mg < ä¸‹é™: ${minSafe.toFixed(2)}mg`; }
        else if (inputDose > maxSafe) { resBox.className="audit-box audit-danger"; resBox.innerHTML=`<strong>ğŸ”¼ éé‡</strong><br>å…¥åŠ›: ${inputDose}mg > ä¸Šé™: ${maxSafe.toFixed(2)}mg${limitMsg}`; }
        else { resBox.className="audit-box audit-safe"; resBox.innerHTML=`<strong>âœ… é©æ­£ç¯„å›²å†…</strong><br>å…¥åŠ›: ${inputDose}mg ã¯ç›®å®‰å†…ã§ã™ã€‚`; }
    }

    // --- ã‚³ãƒ³ãƒãƒ¼ã‚¿ãƒ¼æ©Ÿèƒ½ ---
    function parseExcelData() {
        const raw = document.getElementById('pasteArea').value;
        if (!raw.trim()) { alert("ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"); return null; }
        const rows = []; let currentRow = [], currentCell = "", inQuote = false;
        for (let i = 0; i < raw.length; i++) {
            const char = raw[i], nextChar = raw[i+1];
            if (inQuote) {
                if (char === '"' && nextChar === '"') { currentCell += '"'; i++; } else if (char === '"') { inQuote = false; } else { currentCell += char; }
            } else {
                if (char === '"') { inQuote = true; } else if (char === '\t') { currentRow.push(currentCell); currentCell = ""; } else if (char === '\n' || char === '\r') {
                    if (char === '\r' && nextChar === '\n') i++; currentRow.push(currentCell); rows.push(currentRow); currentRow = []; currentCell = "";
                } else { currentCell += char; }
            }
        }
        if (currentCell || currentRow.length > 0) { currentRow.push(currentCell); rows.push(currentRow); }

        const result = [];
        rows.forEach(cols => {
            if (cols.length < 4) return;
            const min = parseFloat(cols[4]), max = parseFloat(cols[5]), flag = parseInt(cols[6]);
            const limit = parseFloat(cols[7]), refsRaw = cols[8] ? cols[8].trim() : "", ageRuleRaw = cols[9] ? cols[9].trim() : "";
            
            let rule = null;
            if (!isNaN(min) && !isNaN(max) && !isNaN(flag)) rule = { min: min, max: max, unit: flag, limitDay: isNaN(limit) ? null : limit };
            
            let ageRule = null;
            if (ageRuleRaw) {
                const list = [];
                ageRuleRaw.split(',').forEach(p => {
                    const m = p.match(/([\d\.]+)-([\d\.]+):([\d\.]+)/);
                    if(m) list.push({ start: parseFloat(m[1]), end: parseFloat(m[2]), dose: parseFloat(m[3]) });
                });
                if(list.length > 0) ageRule = { list: list, unit: !isNaN(flag) ? flag : 0 };
            }
            let refs = refsRaw ? refsRaw.split(/[,ã€\s]+/).map(s => parseInt(s.replace(/\D/g, ''))).filter(n => !isNaN(n)) : [];

            result.push({ name: cols[0].trim(), generic: cols[1].trim(), yomi: cols[2].trim(), text: cols[3].trim(), rule: rule, ageRule: ageRule, refs: refs });
        });
        return result;
    }

    function applyLocalData() {
        const data = parseExcelData();
        if(!data) return;
        dbDrugs = data;
        localStorage.setItem('pediatric_drug_db', JSON.stringify(data));
        document.getElementById('loadingStatus').innerHTML = `ğŸ“ ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿é©ç”¨ä¸­ (${data.length}ä»¶)`;
        alert("ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¾ã—ãŸã€‚");
    }

    function downloadJsonFile() {
        const data = parseExcelData();
        if(!data) return;
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'database.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    // --- ãã®ä»– ---
    const growthData = { boy: [[0,3.0],[1,9.6],[2,12.5],[3,14.6],[4,16.7],[5,18.9],[6,21.4],[7,24.1],[8,27.2],[9,30.6],[10,34.2],[11,38.2],[12,42.5]], girl: [[0,3.0],[1,8.9],[2,11.8],[3,14.0],[4,16.2],[5,18.5],[6,20.9],[7,23.6],[8,26.5],[9,30.0],[10,33.8],[11,38.0],[12,42.0]] };
    function calcAugsberger() { const ad = parseFloat(document.getElementById('augAdult').value); const wt = parseFloat(document.getElementById('augWeight').value); if (ad && wt) document.getElementById('augResult').textContent = (ad * (wt * 4 + 20) / 100).toFixed(1); }
    function drawGrowthChart(cid, type) {
        const w=300, h=250, pad=30;
        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("width","100%"); svg.setAttribute("height","100%"); svg.setAttribute("viewBox",`0 0 ${w} ${h}`);
        const d = growthData[type];
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d",`M${pad},${pad} V${h-pad} H${w-pad}`);
        path.setAttribute("stroke","#333"); path.setAttribute("stroke-width","1"); path.setAttribute("fill","none");
        svg.appendChild(path);
        let lineD = `M`;
        d.forEach((p,i)=>{
            const x=pad+(p[0]/12)*(w-pad*2); const y=(h-pad)-(p[1]/50)*(h-pad*2);
            lineD+=`${i===0?'':','}${x} ${y}`;
            const c=document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttribute("cx",x); c.setAttribute("cy",y); c.setAttribute("r",2); c.setAttribute("fill",type==='boy'?'#3498db':'#e74c3c');
            svg.appendChild(c);
        });
        const line = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        line.setAttribute("points",lineD.replace(/M/,''));
        line.setAttribute("stroke",type==='boy'?'#3498db':'#e74c3c'); line.setAttribute("stroke-width","2"); line.setAttribute("fill","none");
        svg.appendChild(line);
        document.getElementById(cid).appendChild(svg);
    }
    function drawGrowthTable() {
        const c = document.getElementById('growthTableContainer');
        let h = '<table class="common-table"><thead><tr><th>å¹´é½¢</th>';
        growthData.boy.forEach(p=>h+=`<th>${p[0]}</th>`);
        h+='</tr></thead><tbody><tr><th>ç”·å­</th>';
        growthData.boy.forEach(p=>h+=`<td>${p[1]}</td>`);
        h+='</tr><tr><th>å¥³å­</th>';
        growthData.girl.forEach(p=>h+=`<td>${p[1]}</td>`);
        h+='</tr></tbody></table>';
        c.innerHTML = h;
    }
</script>
</body>
</html>
